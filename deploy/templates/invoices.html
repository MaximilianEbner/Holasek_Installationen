{% extends "base.html" %}

{% block title %}Rechnungen{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Rechnungsübersicht</h2>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">
            <i class="bi bi-plus-circle"></i> Neue Rechnung
        </button>
    </div>
</div>

<!-- Statistiken Dashboard -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h5 class="card-title">Offene Rechnungen</h5>
                <h3>{{ stats.open_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">Bezahlte Rechnungen</h5>
                <h3>{{ stats.paid_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h5 class="card-title">Überfällige Rechnungen</h5>
                <h3>{{ stats.overdue_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">Bezahlter Gesamtbetrag</h5>
                <h3>{{ stats.total_amount|currency }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Filter und Suche -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">Alle Status</option>
                    <option value="erstellt" {{ 'selected' if request.args.get('status') == 'erstellt' }}>Erstellt</option>
                    <option value="versendet" {{ 'selected' if request.args.get('status') == 'versendet' }}>Versendet</option>
                    <option value="bezahlt" {{ 'selected' if request.args.get('status') == 'bezahlt' }}>Bezahlt</option>
                    <option value="ueberfaellig" {{ 'selected' if request.args.get('status') == 'ueberfaellig' }}>Überfällig</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Typ</label>
                <select name="invoice_type" class="form-select">
                    <option value="">Alle Typen</option>
                    <option value="anzahlung" {{ 'selected' if request.args.get('invoice_type') == 'anzahlung' }}>Anzahlung</option>
                    <option value="schluss" {{ 'selected' if request.args.get('invoice_type') == 'schluss' }}>Schlussrechnung</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Zeitraum</label>
                <select name="period" class="form-select">
                    <option value="">Alle Zeiträume</option>
                    <option value="today" {{ 'selected' if request.args.get('period') == 'today' }}>Heute</option>
                    <option value="week" {{ 'selected' if request.args.get('period') == 'week' }}>Diese Woche</option>
                    <option value="month" {{ 'selected' if request.args.get('period') == 'month' }}>Dieser Monat</option>
                    <option value="quarter" {{ 'selected' if request.args.get('period') == 'quarter' }}>Dieses Quartal</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Suche</label>
                <div class="input-group">
                    <input type="text" name="search" class="form-control" placeholder="Rechnungsnummer, Kunde..." value="{{ request.args.get('search', '') }}">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Rechnungstabelle -->
<div class="card">
    <div class="card-body">
        {% if invoices.items %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Rechnungsnummer</th>
                        <th>Kunde</th>
                        <th>Typ</th>
                        <th>Betrag</th>
                        <th>Fällig am</th>
                        <th>Status</th>
                        <th>Erstellt am</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices.items %}
                    <tr>
                        <td>
                            <strong>{{ invoice.invoice_number }}</strong><br>
                            <small class="text-muted">{{ invoice.order.order_number }}</small>
                        </td>
                        <td>
                            <strong>{{ invoice.order.quote.customer.full_name }}</strong><br>
                            <small class="text-muted">{{ invoice.order.quote.customer.city or '' }}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">
                                {{ invoice.invoice_type.title() }}
                            </span><br>
                            <small>{{ invoice.percentage }}%</small>
                        </td>
                        <td>
                            <strong>{{ invoice.gross_amount|currency }}</strong><br>
                            <small class="text-muted">netto: {{ invoice.final_amount|currency }}</small>
                        </td>
                        <td>
                            {{ invoice.due_date.strftime('%d.%m.%Y') }}
                            {% if invoice.is_overdue() %}
                            <br><small class="text-danger">{{ invoice.days_overdue() }} Tage überfällig</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {{ invoice.get_status_badge_class() }}">
                                {{ invoice.status.title() }}
                            </span>
                        </td>
                        <td>{{ invoice.created_at.strftime('%d.%m.%Y') }}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <!-- PDF Download -->
                                <a href="{{ url_for('download_invoice_pdf', id=invoice.id) }}" 
                                   class="btn btn-outline-danger btn-sm" 
                                   title="PDF herunterladen">
                                    <i class="bi bi-file-pdf"></i>
                                </a>
                                
                                <!-- Details anzeigen -->
                                <button class="btn btn-outline-info btn-sm" 
                                        onclick="showInvoiceDetails({{ invoice.id }})"
                                        title="Details anzeigen">
                                    <i class="bi bi-eye"></i>
                                </button>
                                
                                <!-- Status ändern -->
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-success btn-sm dropdown-toggle" 
                                            data-bs-toggle="dropdown" 
                                            title="Status ändern">
                                        <i class="bi bi-gear"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <!-- Vorwärts-Status -->
                                        {% if invoice.status == 'erstellt' %}
                                        <li><a class="dropdown-item" href="#" onclick="updateInvoiceStatus({{ invoice.id }}, 'versendet')">
                                            <i class="bi bi-send"></i> Als versendet markieren</a></li>
                                        {% endif %}
                                        {% if invoice.status in ['erstellt', 'versendet'] %}
                                        <li><a class="dropdown-item" href="#" onclick="markAsPaid({{ invoice.id }})">
                                            <i class="bi bi-check-circle"></i> Als bezahlt markieren</a></li>
                                        {% endif %}
                                        
                                        <!-- Retour-Status -->
                                        {% if invoice.status == 'bezahlt' %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-warning" href="#" onclick="updateInvoiceStatus({{ invoice.id }}, 'versendet')">
                                            <i class="bi bi-arrow-left"></i> Zurück zu "Versendet"</a></li>
                                        {% endif %}
                                        {% if invoice.status == 'versendet' %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-secondary" href="#" onclick="updateInvoiceStatus({{ invoice.id }}, 'erstellt')">
                                            <i class="bi bi-arrow-left"></i> Zurück zu "Erstellt"</a></li>
                                        {% endif %}
                                    </ul>
                                </div>
                                
                                <!-- Löschen (nur wenn nicht bezahlt) -->
                                {% if invoice.status != 'bezahlt' %}
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="deleteInvoice({{ invoice.id }})"
                                        title="Rechnung löschen">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if invoices.pages > 1 %}
        <nav aria-label="Rechnungen Pagination">
            <ul class="pagination justify-content-center">
                {% if invoices.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('invoices', page=invoices.prev_num, **request.args) }}">Zurück</a>
                </li>
                {% endif %}
                
                {% for page_num in invoices.iter_pages() %}
                {% if page_num %}
                {% if page_num != invoices.page %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('invoices', page=page_num, **request.args) }}">{{ page_num }}</a>
                </li>
                {% else %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% endif %}
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">…</span>
                </li>
                {% endif %}
                {% endfor %}
                
                {% if invoices.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('invoices', page=invoices.next_num, **request.args) }}">Weiter</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-receipt" style="font-size: 3rem; color: #ccc;"></i>
            <h4 class="mt-3 text-muted">Keine Rechnungen gefunden</h4>
            <p class="text-muted">Erstellen Sie Ihre erste Rechnung über die Auftragsübersicht.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal: Neue Rechnung erstellen -->
<div class="modal fade" id="createInvoiceModal" tabindex="-1" aria-labelledby="createInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createInvoiceModalLabel">Neue Rechnung erstellen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createInvoiceForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="order_id" class="form-label">Auftrag *</label>
                        <select name="order_id" id="order_id" class="form-select" required>
                            <option value="">Auftrag auswählen...</option>
                            {% for order in available_orders %}
                            <option value="{{ order.id }}">
                                {{ order.order_number }} - {{ order.quote.customer.full_name }} 
                                ({{ order.quote.total_amount|currency }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="invoice_type" class="form-label">Rechnungstyp *</label>
                        <select name="invoice_type" id="invoice_type" class="form-select" required>
                            <option value="">Typ auswählen...</option>
                            <option value="anzahlung">Anzahlungsrechnung</option>
                            <option value="schluss">Schlussrechnung</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="percentage" class="form-label">Prozentsatz *</label>
                        <div class="input-group">
                            <input type="number" name="percentage" id="percentage" class="form-control" min="1" max="100" step="1" required>
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="form-text">Typisch: Anzahlung 30%, Schlussrechnung 70%</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="due_date" class="form-label">Fälligkeitsdatum *</label>
                        <input type="date" name="due_date" id="due_date" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Rechnung erstellen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Als bezahlt markieren -->
<div class="modal fade" id="markPaidModal" tabindex="-1" aria-labelledby="markPaidModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="markPaidModalLabel">Rechnung als bezahlt markieren</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="markPaidForm">
                <div class="modal-body">
                    <input type="hidden" id="paid_invoice_id" name="invoice_id">
                    
                    <div class="mb-3">
                        <label for="paid_date" class="form-label">Bezahldatum</label>
                        <input type="date" name="paid_date" id="paid_date" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_reference" class="form-label">Zahlungsreferenz</label>
                        <input type="text" name="payment_reference" id="payment_reference" class="form-control" placeholder="z.B. Überweisungsreferenz">
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_comment" class="form-label">Kommentar</label>
                        <textarea name="comment" id="payment_comment" class="form-control" rows="2" placeholder="Optional: Zusätzliche Informationen"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-success">Als bezahlt markieren</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Rechnung erstellen
document.getElementById('createInvoiceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{{ url_for("create_invoice") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Fehler: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ein Fehler ist aufgetreten: ' + error);
    });
});

// Als bezahlt markieren
function markAsPaid(invoiceId) {
    document.getElementById('paid_invoice_id').value = invoiceId;
    new bootstrap.Modal(document.getElementById('markPaidModal')).show();
}

document.getElementById('markPaidForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const invoiceId = document.getElementById('paid_invoice_id').value;
    const formData = new FormData(this);
    
    fetch(`/invoices/${invoiceId}/mark_paid`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Fehler: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ein Fehler ist aufgetreten: ' + error);
    });
});

// Status aktualisieren
function updateInvoiceStatus(invoiceId, newStatus) {
    fetch(`/invoices/${invoiceId}/update_status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({status: newStatus})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Fehler: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ein Fehler ist aufgetreten: ' + error);
    });
}

// Rechnung löschen
function deleteInvoice(invoiceId) {
    if (confirm('Sind Sie sicher, dass Sie diese Rechnung löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.')) {
        fetch(`/invoices/${invoiceId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Rechnung wurde erfolgreich gelöscht.');
                location.reload();
            } else {
                alert('Fehler beim Löschen: ' + data.message);
            }
        })
        .catch(error => {
            alert('Ein Fehler ist aufgetreten: ' + error);
        });
    }
}

// Rechnungsdetails anzeigen
function showInvoiceDetails(invoiceId) {
    fetch(`/invoices/${invoiceId}`)
    .then(response => response.text())
    .then(html => {
        // Erstelle Modal-Container falls nicht vorhanden
        let modalContainer = document.getElementById('invoiceDetailsModal');
        if (!modalContainer) {
            modalContainer = document.createElement('div');
            modalContainer.id = 'invoiceDetailsModal';
            document.body.appendChild(modalContainer);
        }
        modalContainer.innerHTML = html;
        
        // Modal anzeigen
        new bootstrap.Modal(modalContainer.querySelector('.modal')).show();
    })
    .catch(error => {
        alert('Fehler beim Laden der Details: ' + error);
    });
}

// Fälligkeitsdatum automatisch setzen
document.getElementById('due_date').valueAsDate = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000);

// Bezahldatum auf heute setzen
document.getElementById('paid_date').valueAsDate = new Date();

// Bootstrap Dropdowns explizit initialisieren
document.addEventListener('DOMContentLoaded', function() {
    // Alle Dropdown-Toggle-Buttons finden und initialisieren
    var dropdownElementList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'));
    var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
        return new bootstrap.Dropdown(dropdownToggleEl);
    });
    
    // Filter-Dropdowns aktivieren - automatisches Abschicken bei Änderung
    const filterForm = document.querySelector('form[method="GET"]');
    const filterSelects = filterForm.querySelectorAll('select[name="status"], select[name="invoice_type"], select[name="period"]');
    
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            filterForm.submit();
        });
    });
});

// Prozentsatz-Vorschläge basierend auf Rechnungstyp
document.getElementById('invoice_type').addEventListener('change', function() {
    const percentageField = document.getElementById('percentage');
    if (this.value === 'anzahlung') {
        percentageField.value = 30;
    } else if (this.value === 'schluss') {
        percentageField.value = 70;
    }
});
</script>
{% endblock %}
