{% extends "base.html" %}

{% block title %}Neue Rechnung erstellen{% endblock %}

{% block extra_css %}
<style>
/* Card-basierte Auswahl Styling */
.card-selection {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e9ecef;
}

.card-selection:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.card-selection.selected {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea10, #764ba210);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.card-selection .card-body {
    padding: 1.5rem;
    text-align: center;
}

.card-selection i {
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.card-selection .card-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #2d3748;
}

.card-selection .badge {
    font-size: 0.8rem;
}

/* Auftragssuche Dropdown Styling */
#order_dropdown {
    display: none;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    background: white;
    z-index: 1050;
}

#order_dropdown .dropdown-item {
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #f8f9fa;
    cursor: pointer;
}

#order_dropdown .dropdown-item:hover {
    background-color: #f8f9fa;
}

#order_dropdown .dropdown-item:last-child {
    border-bottom: none;
}

/* Formular-Styling */
.form-section {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.section-title {
    color: #2d3748;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-title i {
    color: #667eea;
    font-size: 1.2rem;
}

.calculation-display {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    font-weight: 500;
    color: #495057;
    text-align: right;
}

.btn-primary-custom {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 6px;
    color: white;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-primary-custom:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
}

.hidden-section {
    display: none !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4"><i class="bi bi-plus-circle"></i> Neue Rechnung erstellen</h2>
            
            <!-- Schritt 1: Rechnungstyp auswählen -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-1-circle"></i>
                    Rechnungstyp auswählen
                </h4>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card card-selection" data-type="anzahlung">
                            <div class="card-body">
                                <i class="bi bi-cash-coin text-success"></i>
                                <h6 class="card-title">Anzahlungsrechnung</h6>
                                <span class="badge bg-success">30%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card card-selection" data-type="schluss">
                            <div class="card-body">
                                <i class="bi bi-check-circle text-primary"></i>
                                <h6 class="card-title">Schlussrechnung</h6>
                                <span class="badge bg-primary">70%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card card-selection" data-type="detailed_final">
                            <div class="card-body">
                                <i class="bi bi-list-columns text-info"></i>
                                <h6 class="card-title">Detaillierte Schlussrechnung</h6>
                                <span class="badge bg-info">Detail</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card card-selection" data-type="allgemein">
                            <div class="card-body">
                                <i class="bi bi-file-text text-warning"></i>
                                <h6 class="card-title">Allgemeine Rechnung</h6>
                                <span class="badge bg-warning">Einfach</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6 offset-md-3">
                        <div class="card card-selection" data-type="allgemein_erweitert">
                            <div class="card-body">
                                <i class="bi bi-gear-wide-connected text-purple"></i>
                                <h6 class="card-title">Allgemeine Rechnung (erweitert)</h6>
                                <span class="badge bg-secondary">Positionen</span>
                                <p class="mt-2 mb-0 small text-muted">Mit Positionsverwaltung und Artikel-Integration</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Verstecktes Input für ausgewählten Typ -->
                <input type="hidden" id="selected_invoice_type" name="invoice_type" value="">
                
                <!-- Info-Box für gewählten Typ -->
                <div id="type-info" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Beschreibung:</strong> <span id="type-description"></span>
                    </div>
                </div>
            </div>
            
            <!-- Anzahlungsrechnung Formular -->
            <div id="anzahlung-form" class="form-section hidden-section">
                <h4 class="section-title">
                    <i class="bi bi-cash-coin text-success"></i>
                    Anzahlungsrechnung - 30%
                </h4>
                <form method="POST" action="{{ url_for('create_invoice') }}">
                    <input type="hidden" name="invoice_type" value="anzahlung">
                    
                    <!-- Auftrag auswählen -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="order_search" class="form-label">Auftrag auswählen *</label>
                            <div class="position-relative">
                                <input type="text" id="order_search" class="form-control" 
                                       placeholder="Auftragsnummer oder Kundenname eingeben..." 
                                       autocomplete="off" required>
                                <input type="hidden" name="order_id" id="order_id">
                                <div id="order_dropdown" class="position-absolute w-100" 
                                     style="max-height: 300px; overflow-y: auto; z-index: 1050; display: none; background: white; border: 1px solid #ced4da; border-radius: 0.375rem;">
                                    <!-- Dropdown wird dynamisch gefüllt -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Auftragssumme</label>
                            <div id="order_total_display" class="calculation-display">
                                Auftrag auswählen...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rechnungsdetails -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="percentage" class="form-label">Anzahlungs-Prozentsatz *</label>
                            <div class="input-group">
                                <input type="number" name="percentage" id="percentage" class="form-control" 
                                       value="30" min="1" max="100" step="1" required>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Rechnungsbetrag (netto)</label>
                            <div id="invoice_amount" class="calculation-display">0,00 €</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bruttobetrag (inkl. 20% MwSt.)</label>
                            <div id="gross_amount" class="calculation-display">0,00 €</div>
                        </div>
                    </div>
                    
                    <!-- Zahlungskonditionen -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="due_date" class="form-label">Fälligkeitsdatum *</label>
                            <input type="date" name="due_date" id="due_date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">MwSt.-Satz</label>
                            <div class="calculation-display">20% (Standard)</div>
                            <input type="hidden" name="vat_rate" id="vat_rate" value="20.0">
                        </div>
                    </div>
                    
                    <!-- Leistungsbeschreibung -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="service_description" class="form-label">Leistungsbeschreibung</label>
                            <textarea name="service_description" id="service_description" class="form-control" rows="3" 
                                      placeholder="Beschreibung der erbrachten Leistung für die Anzahlungsrechnung..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Aktionen -->
                    <div class="row">
                        <div class="col-12 d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" onclick="hideAllForms()">
                                <i class="bi bi-x-circle"></i> Abbrechen
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Anzahlungsrechnung erstellen
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Schlussrechnung Formular -->
            <div id="schluss-form" class="form-section hidden-section">
                <h4 class="section-title">
                    <i class="bi bi-check-circle text-primary"></i>
                    Schlussrechnung - Restbetrag
                </h4>
                <form method="POST" action="{{ url_for('create_invoice') }}">
                    <input type="hidden" name="invoice_type" value="schluss">
                    
                    <!-- Auftrag auswählen -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="schluss_order_search" class="form-label">Auftrag auswählen *</label>
                            <div class="position-relative">
                                <input type="text" id="schluss_order_search" class="form-control" 
                                       placeholder="Auftragsnummer oder Kundenname eingeben..." 
                                       autocomplete="off" required>
                                <input type="hidden" name="order_id" id="schluss_order_id">
                                <div id="schluss_order_dropdown" class="position-absolute w-100" 
                                     style="max-height: 300px; overflow-y: auto; z-index: 1050; display: none; background: white; border: 1px solid #ced4da; border-radius: 0.375rem;">
                                    <!-- Dropdown wird dynamisch gefüllt -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Auftragssumme</label>
                            <div id="schluss_order_total_display" class="calculation-display">
                                Auftrag auswählen...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rechnungsdetails -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Bereits bezahlt (Anzahlung)</label>
                            <div id="schluss_previous_payments" class="calculation-display text-success">0,00 €</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Restbetrag (netto)</label>
                            <div id="schluss_invoice_amount" class="calculation-display">0,00 €</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bruttobetrag (inkl. 20% MwSt.)</label>
                            <div id="schluss_gross_amount" class="calculation-display">0,00 €</div>
                        </div>
                    </div>
                    
                    <!-- Zahlungskonditionen -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="schluss_due_date" class="form-label">Fälligkeitsdatum *</label>
                            <input type="date" name="due_date" id="schluss_due_date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">MwSt.-Satz</label>
                            <div class="calculation-display">20% (Standard)</div>
                        </div>
                    </div>
                    
                    <!-- Leistungsbeschreibung -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="schluss_service_description" class="form-label">Leistungsbeschreibung</label>
                            <textarea name="service_description" id="schluss_service_description" class="form-control" rows="3" 
                                      placeholder="Beschreibung der erbrachten Leistung für die Schlussrechnung..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Aktionen -->
                    <div class="row">
                        <div class="col-12 d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" onclick="hideAllForms()">
                                <i class="bi bi-x-circle"></i> Abbrechen
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Schlussrechnung erstellen
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Allgemeine Rechnung Formular -->
            <div id="allgemein-form" class="form-section hidden-section">
                <h4 class="section-title">
                    <i class="bi bi-file-text text-warning"></i>
                    Allgemeine Rechnung
                </h4>
                <form method="POST" action="{{ url_for('create_invoice') }}">
                    <input type="hidden" name="invoice_type" value="allgemein">
                    
                    <!-- Kunde auswählen -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="customer_search" class="form-label">Kunde auswählen *</label>
                            <div class="position-relative">
                                <input type="text" id="customer_search" class="form-control" 
                                       placeholder="Kundennamen eingeben..." 
                                       autocomplete="off" required>
                                <input type="hidden" name="customer_id" id="customer_id">
                                <div id="customer_dropdown" class="position-absolute w-100" 
                                     style="max-height: 300px; overflow-y: auto; z-index: 1050; display: none; background: white; border: 1px solid #ced4da; border-radius: 0.375rem;">
                                    <!-- Dropdown wird dynamisch gefüllt -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rechnungsdetails -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="allgemein_amount" class="form-label">Nettobetrag *</label>
                            <div class="input-group">
                                <input type="number" name="net_amount" id="allgemein_amount" class="form-control" 
                                       min="0" step="0.01" required>
                                <span class="input-group-text">€</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">MwSt. (20%)</label>
                            <div id="allgemein_vat_amount" class="calculation-display">0,00 €</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bruttobetrag</label>
                            <div id="allgemein_gross_amount" class="calculation-display">0,00 €</div>
                        </div>
                    </div>
                    
                    <!-- Zahlungskonditionen -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="allgemein_due_date" class="form-label">Fälligkeitsdatum *</label>
                            <input type="date" name="due_date" id="allgemein_due_date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">MwSt.-Satz</label>
                            <div class="calculation-display">20% (Standard)</div>
                        </div>
                    </div>
                    
                    <!-- Leistungsbeschreibung -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="allgemein_service_description" class="form-label">Leistungsbeschreibung *</label>
                            <textarea name="service_description" id="allgemein_service_description" class="form-control" rows="4" 
                                      placeholder="Detaillierte Beschreibung der erbrachten Leistungen..." required></textarea>
                        </div>
                    </div>
                    
                    <!-- Aktionen -->
                    <div class="row">
                        <div class="col-12 d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" onclick="hideAllForms()">
                                <i class="bi bi-x-circle"></i> Abbrechen
                            </button>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-check-circle"></i> Allgemeine Rechnung erstellen
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Weitere Sektionen werden hier dynamisch angezeigt -->
            <div id="remaining-sections">
                <!-- Diese werden je nach Auswahl eingeblendet -->
            </div>
            
        </div>
    </div>
</div>

<script>
// Verfügbare Aufträge aus Backend
const availableOrders = {{ available_orders_json|safe }};
const availableCustomers = {{ customers_json|safe }};

// Typ-Informationen
const typeInfos = {
    'anzahlung': 'Anzahlungsrechnung über 30% der Auftragssumme. Wird vor Arbeitsbeginn gestellt.',
    'schluss': 'Schlussrechnung über 70% der Auftragssumme abzüglich bereits erhaltener Anzahlungen.',
    'detailed_final': 'Detaillierte Schlussrechnung mit separater Aufstellung von Material- und Arbeitskosten.',
    'allgemein': 'Allgemeine Rechnung ohne Auftragsbezug. Freier Betrag und Leistungsbeschreibung.',
    'allgemein_erweitert': 'Erweiterte allgemeine Rechnung mit Positionsverwaltung, Artikeln und flexibler Gestaltung.'
};

// DOM-Elemente
const typeInfo = document.getElementById('type-info');
const typeDescription = document.getElementById('type-description');
const selectedTypeInput = document.getElementById('selected_invoice_type');

// Card-Selection Event Listeners
document.querySelectorAll('.card-selection').forEach(card => {
    card.addEventListener('click', function() {
        const selectedType = this.getAttribute('data-type');
        
        // Alle Karten deselektieren
        document.querySelectorAll('.card-selection').forEach(c => c.classList.remove('selected'));
        
        // Diese Karte selektieren
        this.classList.add('selected');
        
        // Hidden Input setzen
        selectedTypeInput.value = selectedType;
        
        // Typ-Info anzeigen
        showTypeInfo(selectedType);
        
        // Je nach Typ entsprechende Aktion
        if (selectedType === 'allgemein_erweitert') {
            // Zur erweiterten allgemeinen Rechnung weiterleiten
            window.location.href = '{{ url_for("new_general_invoice") }}';
        } else {
            // Für andere Typen zeige entsprechendes Formular
            hideAllForms();
            showFormForType(selectedType);
        }
    });
});

// Funktionen
function showTypeInfo(type) {
    if (typeInfos[type]) {
        typeDescription.textContent = typeInfos[type];
        typeInfo.style.display = 'block';
    }
}

function hideAllForms() {
    document.getElementById('anzahlung-form').classList.add('hidden-section');
    document.getElementById('schluss-form').classList.add('hidden-section');
    document.getElementById('allgemein-form').classList.add('hidden-section');
}

function showFormForType(type) {
    switch(type) {
        case 'anzahlung':
            document.getElementById('anzahlung-form').classList.remove('hidden-section');
            // Set default due date to 14 days from now
            const anzahlungDate = new Date();
            anzahlungDate.setDate(anzahlungDate.getDate() + 14);
            document.getElementById('due_date').value = anzahlungDate.toISOString().split('T')[0];
            break;
            
        case 'schluss':
            document.getElementById('schluss-form').classList.remove('hidden-section');
            // Set default due date to 30 days from now
            const schlussDate = new Date();
            schlussDate.setDate(schlussDate.getDate() + 30);
            document.getElementById('schluss_due_date').value = schlussDate.toISOString().split('T')[0];
            break;
            
        case 'allgemein':
            document.getElementById('allgemein-form').classList.remove('hidden-section');
            // Set default due date to 14 days from now
            const allgemeinDate = new Date();
            allgemeinDate.setDate(allgemeinDate.getDate() + 14);
            document.getElementById('allgemein_due_date').value = allgemeinDate.toISOString().split('T')[0];
            break;
    }
}
</script>
{% endblock %}