{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>Angebot bearbeiten: {{ quote.quote_number }}</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('quotes') }}">Angebote</a></li>
                        <li class="breadcrumb-item active">{{ quote.quote_number }}</li>
                    </ol>
                </nav>
            </div>
            <div>
                <div class="btn-group me-2" role="group">
                    <a href="{{ url_for('view_quote', id=quote.id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-eye"></i> Anzeigen
                    </a>
                    <a href="{{ url_for('export_quote_pdf', id=quote.id) }}" class="btn btn-outline-info">
                        <i class="fas fa-file-pdf"></i> PDF
                    </a>
                    {% if quote.status == 'Entwurf' %}
                    <a href="{{ url_for('send_quote', id=quote.id) }}" class="btn btn-success"
                       onclick="return confirm('Angebot als gesendet markieren?')">
                        <i class="fas fa-paper-plane"></i> Senden
                    </a>
                    {% elif quote.status == 'Gesendet' %}
                    <a href="{{ url_for('accept_quote', id=quote.id) }}" class="btn btn-success"
                       onclick="return confirm('Angebot als angenommen markieren?')">
                        <i class="fas fa-check"></i> Angenommen
                    </a>
                    <a href="{{ url_for('reject_quote', id=quote.id) }}" class="btn btn-danger">
                        <i class="fas fa-times"></i> Abgelehnt
                    </a>
                    {% elif quote.status == 'Angenommen' %}
                    {% if quote.order %}
                    <a href="{{ url_for('view_order', order_id=quote.order.id) }}" class="btn btn-success">
                        <i class="fas fa-clipboard-check"></i> Auftrag anzeigen
                    </a>
                    {% else %}
                    <a href="{{ url_for('create_order', quote_id=quote.id) }}" class="btn btn-primary">
                        <i class="fas fa-arrow-right"></i> Auftrag erstellen
                    </a>
                    {% endif %}
                    {% endif %}
                    
                    {% if quote.status != 'Entwurf' %}
                    <a href="{{ url_for('reset_quote', id=quote.id) }}" class="btn btn-outline-secondary"
                       onclick="return confirm('Angebot zurück auf Entwurf setzen?')">
                        <i class="fas fa-undo"></i> Zurücksetzen
                    </a>
                    {% endif %}
                </div>
                
                <span class="badge bg-{{ 'secondary' if quote.status == 'Entwurf' else 'primary' if quote.status == 'Gesendet' else 'success' if quote.status == 'Angenommen' else 'danger' }} fs-6">
                    {{ quote.status }}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Angebotsinformationen -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Kundendaten</h5>
            </div>
            <div class="card-body">
                <p><strong>{{ quote.customer.first_name }} {{ quote.customer.last_name }}</strong></p>
                <p class="mb-1">{{ quote.customer.email }}</p>
                <p class="mb-1">{{ quote.customer.phone or 'Keine Telefonnummer' }}</p>
                {% if quote.customer.address %}
                <p class="mb-0">{{ quote.customer.address }}<br>
                {{ quote.customer.postal_code }} {{ quote.customer.city }}</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Angebotsdaten</h5>
            </div>
            <div class="card-body">
                <p><strong>Angebotsnummer:</strong> {{ quote.quote_number }}</p>
                <p><strong>Erstellt am:</strong> {{ quote.created_at.strftime('%d.%m.%Y') }}</p>
                <p><strong>Gültig bis:</strong> {{ quote.valid_until.strftime('%d.%m.%Y') }}</p>
                
                <!-- Preisaufschlüsselung -->
                <div class="border rounded p-3 bg-light">
                    <div class="row">
                        <div class="col-6"><strong>Nettosumme:</strong></div>
                        <div class="col-6 text-end" id="base-total-display">{{ "%.2f"|format(quote.calculate_net_total()) }} €</div>
                    </div>
                    <div class="row">
                        <div class="col-6">Aufschlag ({{ quote.markup_percentage or 15 }}%):</div>
                        <div class="col-6 text-end" id="markup-amount-display">{{ "%.2f"|format(quote.calculate_markup_amount()) }} €</div>
                    </div>
                    <hr class="my-2">
                    <div class="row">
                        <div class="col-6"><strong>Gesamtsumme:</strong></div>
                        <div class="col-6 text-end"><span class="h5 text-success" id="total-amount-display">{{ "%.2f"|format(quote.calculate_total()) }} €</span></div>
                    </div>
                </div>
                
                <hr>
                <h6>Status-Workflow:</h6>
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-{{ 'success' if quote.status == 'Entwurf' else 'secondary' }} me-2">1</span>
                    <span class="{{ 'fw-bold' if quote.status == 'Entwurf' else 'text-muted' }}">Entwurf</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-{{ 'success' if quote.status == 'Gesendet' else 'secondary' }} me-2">2</span>
                    <span class="{{ 'fw-bold' if quote.status == 'Gesendet' else 'text-muted' }}">Gesendet</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-{{ 'success' if quote.status == 'Angenommen' else 'danger' if quote.status == 'Abgelehnt' else 'secondary' }} me-2">3</span>
                    <span class="{{ 'fw-bold' if quote.status in ['Angenommen', 'Abgelehnt'] else 'text-muted' }}">Angenommen/Abgelehnt</span>
                </div>
                
                {% if quote.status == 'Abgelehnt' and quote.rejection %}
                <div class="alert alert-warning mt-3">
                    <h6><i class="fas fa-times-circle"></i> Ablehnungsgrund:</h6>
                    <p class="mb-0">{{ quote.rejection.rejection_reason }}</p>
                    <small class="text-muted">Abgelehnt am: {{ quote.rejection.rejected_at.strftime('%d.%m.%Y um %H:%M') }}</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Projektbeschreibung -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Angebotsdaten bearbeiten</h5>
                {% if quote.status != 'Angenommen' %}
                <button type="button" class="btn btn-success btn-sm" onclick="saveQuote()">
                    <i class="fas fa-save"></i> Angebot speichern
                </button>
                {% else %}
                <span class="badge bg-warning">
                    <i class="fas fa-lock"></i> Angebot ist angenommen und eingefroren
                </span>
                {% endif %}
            </div>
            <div class="card-body">
                <form id="quote-edit-form" method="POST" action="{{ url_for('save_quote', id=quote.id) }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Projektbeschreibung *</label>
                            <textarea name="project_description" class="form-control" rows="3" required 
                                      {% if quote.status == 'Angenommen' %}readonly{% endif %}>{{ quote.project_description }}</textarea>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Gültig bis *</label>
                            <input type="date" name="valid_until" class="form-control" 
                                   value="{{ quote.valid_until.strftime('%Y-%m-%d') }}" required
                                   {% if quote.status == 'Angenommen' %}readonly{% endif %}>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Aufschlag *</label>
                            <div class="input-group">
                                <input type="number" name="markup_percentage" class="form-control" 
                                       value="{{ quote.markup_percentage or 15 }}" min="0" max="100" step="0.1" 
                                       id="markup-input" onchange="updateMarkupDisplay()" required
                                       {% if quote.status == 'Angenommen' %}readonly{% endif %}>
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="form-text text-muted">Wird auf alle Positionen aufgeschlagen</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_additional_info" 
                                       id="include-additional-info" {% if quote.include_additional_info %}checked{% endif %}
                                       {% if quote.status == 'Angenommen' %}disabled{% endif %}>
                                <label class="form-check-label" for="include-additional-info">
                                    Zusätzliche Informationen und AGB im PDF einschließen
                                </label>
                            </div>
                            
                            <!-- Neue PDF-Preistransparenz Modi -->
                            <div class="mt-3">
                                <label class="form-label">PDF-Preistransparenz</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="price_display_mode" value="standard" 
                                           id="price-mode-standard" 
                                           {% if not quote.price_display_mode or quote.price_display_mode == 'standard' %}checked{% endif %}
                                           {% if quote.status == 'Angenommen' %}disabled{% endif %}>
                                    <label class="form-check-label" for="price-mode-standard">
                                        <strong>Standard</strong> - Nur Hauptpositionspreise anzeigen (empfohlen)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="price_display_mode" value="detailed" 
                                           id="price-mode-detailed" 
                                           {% if quote.price_display_mode == 'detailed' or (quote.show_subitem_prices and not quote.price_display_mode) %}checked{% endif %}
                                           {% if quote.status == 'Angenommen' %}disabled{% endif %}>
                                    <label class="form-check-label" for="price-mode-detailed">
                                        <strong>Detailliert</strong> - Unterpositionspreise mit Aufschlag anzeigen
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="price_display_mode" value="total_only" 
                                           id="price-mode-total-only" 
                                           {% if quote.price_display_mode == 'total_only' %}checked{% endif %}
                                           {% if quote.status == 'Angenommen' %}disabled{% endif %}>
                                    <label class="form-check-label" for="price-mode-total-only">
                                        <strong>Nur Gesamtbetrag</strong> - Keine Einzelpreise, nur Endsumme
                                    </label>
                                </div>
                                <!-- Kompatibilität: Verstecktes Feld für alte show_subitem_prices -->
                                <input type="hidden" name="show_subitem_prices" value="false">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Positionen hinzufügen -->
{% if quote.status != 'Angenommen' %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <ul class="nav nav-tabs card-header-tabs" id="addPositionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
                                <i class="fas fa-layer-group"></i> Positionsvorlagen
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="detailed-tab" data-bs-toggle="tab" data-bs-target="#detailed" type="button" role="tab">
                                <i class="fas fa-list-ul"></i> Detaillierte Position
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="work-tab" data-bs-toggle="tab" data-bs-target="#work" type="button" role="tab">
                                <i class="fas fa-tools"></i> Arbeitsposition
                            </button>
                        </li>
                    </ul>
                </h5>
            </div>
            <div class="card-body">
                <div class="tab-content" id="addPositionTabsContent">
                    <!-- Arbeitsposition -->
                    <div class="tab-pane fade" id="work" role="tabpanel">
                        <form method="POST" action="{{ url_for('add_work_position', id=quote.id) }}">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Arbeitsposition Beschreibung *</label>
                                    <input type="text" name="description" class="form-control" 
                                           placeholder="z.B. Badumbau komplett" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Position Nr. *</label>
                                    <input type="number" name="position_number" class="form-control" 
                                           value="{{ (quote.quote_items | length) + 1 }}" min="1" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Berechneter Gesamtpreis</label>
                                    <div class="input-group">
                                        <input type="text" id="calculated-work-total" class="form-control" 
                                               readonly style="background-color: #e9ecef;">
                                        <span class="input-group-text">€</span>
                                    </div>
                                    <small class="text-muted">Wird aus Arbeitsschritten berechnet</small>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Standard-Stundensatz</label>
                                    <div class="input-group">
                                        <input type="number" id="work-hourly-rate" class="form-control" 
                                               value="{{ get_default_hourly_rate() }}" step="0.01" 
                                               onchange="calculateWorkTotal()">
                                        <span class="input-group-text">€</span>
                                    </div>
                                    <small class="text-muted">Wird für alle Arbeitsschritte verwendet</small>
                                </div>
                            </div>
                            
                            <hr>
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-tools"></i> Arbeitsschritte auswählen
                                <small>(Stunden können individuell angepasst werden)</small>
                            </h6>
                            
                            <div id="work-steps-container">
                                {% for category, steps in work_steps.items() %}
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">{{ category }}</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {% for step in steps %}
                                            <div class="col-md-6 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input work-step-checkbox" 
                                                           type="checkbox" 
                                                           id="step-{{ category|replace(' ', '')|replace('&', '')|replace('/', '') }}-{{ loop.index }}"
                                                           data-category="{{ category }}"
                                                           data-step="{{ step.name }}"
                                                           data-default-hours="{{ step.default_hours }}"
                                                           onchange="toggleWorkStep(this)">
                                                    <label class="form-check-label" 
                                                           for="step-{{ category|replace(' ', '')|replace('&', '')|replace('/', '') }}-{{ loop.index }}">
                                                        {{ step.name }} ({{ step.default_hours }}h)
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <hr>
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-list"></i> Ausgewählte Arbeitsschritte
                                <small>(Reihenfolge entspricht der Auswahl)</small>
                            </h6>
                            
                            <div id="selected-work-steps">
                                <div class="text-muted text-center py-3">
                                    <i class="fas fa-info-circle"></i> Keine Arbeitsschritte ausgewählt
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save"></i> Arbeitsposition speichern
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Einfache Position -->
                    <div class="tab-pane fade" id="simple" role="tabpanel">
                        <form method="POST" action="{{ url_for('add_quote_item', id=quote.id) }}">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Beschreibung/Leistung *</label>
                                    <input type="text" name="description" class="form-control" 
                                           placeholder="z.B. Sanitärinstallation Badezimmer" required>
                                    <small class="form-text text-muted">Beschreiben Sie die Leistung oder das Material</small>
                                </div>
                                
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Menge *</label>
                                    <input type="number" name="quantity" class="form-control" 
                                           value="1" min="0.1" step="0.1" required onchange="calculateSimpleTotal()">
                                </div>
                                
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Einzelpreis *</label>
                                    <div class="input-group">
                                        <input type="number" name="unit_price" class="form-control" 
                                               min="0" step="0.01" placeholder="0.00" required onchange="calculateSimpleTotal()">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Gesamtpreis</label>
                                    <div class="input-group">
                                        <input type="text" id="simple-calculated-total" class="form-control" readonly>
                                        <span class="input-group-text">€</span>
                                    </div>
                                    <small class="form-text text-muted">Wird automatisch berechnet</small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-10 mb-3">
                                    <label class="form-label">Zusätzliche Details (optional)</label>
                                    <textarea name="additional_notes" class="form-control" rows="2" 
                                              placeholder="Weitere Details zur Position..."></textarea>
                                </div>
                                
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus"></i> Hinzufügen
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Positionsvorlagen -->
                    <div class="tab-pane fade" id="templates" role="tabpanel">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Positionsvorlagen verwenden:</strong> 
                            Wählen Sie aus vorgefertigten Vorlagen und passen Sie die Berechnungsparameter an.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <button type="button" class="btn btn-primary btn-lg w-100" onclick="openTemplateSelector()">
                                    <i class="fas fa-layer-group"></i> 
                                    Positionsvorlage auswählen
                                </button>
                                <p class="text-muted text-center mt-2">
                                    Öffnet den Vorlagen-Selector in einem neuen Fenster
                                </p>
                            </div>
                        </div>
                        
                        <!-- Ausgewählte Template-Info (wird nach Auswahl angezeigt) -->
                        <div id="selectedTemplateInfo" style="display: none;" class="mt-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-check"></i> Ausgewählte Vorlage</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 id="templateInfoName">-</h6>
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">Länge:</small> <span id="templateInfoLength">-</span> cm
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Breite:</small> <span id="templateInfoWidth">-</span> cm
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Höhe:</small> <span id="templateInfoHeight">-</span> cm
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Stunden:</small> <span id="templateInfoHours">-</span>
                                                </div>
                                                <div class="col-12 mt-2">
                                                    <small class="text-muted">Fläche:</small> <span id="templateInfoArea">-</span> m² | 
                                                    <small class="text-muted">Berechneter Preis:</small> <strong class="text-success" id="templateInfoPrice">-</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button type="button" class="btn btn-success" onclick="addSelectedTemplate()">
                                                <i class="fas fa-plus"></i> Position hinzufügen
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="clearSelectedTemplate()">
                                                <i class="fas fa-times"></i> Abbrechen
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detaillierte Position -->
                    <div class="tab-pane fade show active" id="detailed" role="tabpanel">
                        <form method="POST" action="{{ url_for('add_detailed_quote_item', id=quote.id) }}">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Hauptposition Beschreibung *</label>
                                    <input type="text" name="description" class="form-control" 
                                           placeholder="z.B. Duschtasse komplett" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Position Nr. *</label>
                                    <input type="number" name="position_number" class="form-control" 
                                           value="{{ (quote.quote_items | length) + 1 }}" min="1" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Berechneter Gesamtpreis</label>
                                    <div class="input-group">
                                        <input type="text" id="calculated-detail-total" class="form-control" 
                                               readonly style="background-color: #e9ecef;">
                                        <span class="input-group-text">€</span>
                                    </div>
                                    <small class="text-muted">Wird aus Unterpositionen berechnet</small>
                                </div>
                            </div>
                            
                            <hr>
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-list"></i> Unterpositionen 
                                <small>(werden automatisch nummeriert und der Gesamtpreis wird berechnet)</small>
                            </h6>
                            
                            <div id="sub-items-container">
                                <div class="sub-item-row border rounded p-3 mb-3" style="background-color: #f8f9fa;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Unterposition Beschreibung</label>
                                            <input type="text" name="sub_description[]" class="form-control" 
                                                   placeholder="z.B. Mineralguß Duschtasse 170x80cm">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Typ</label>
                                            <select name="sub_item_type[]" class="form-control" onchange="toggleSubItemFields(this, 1)">
                                                <option value="bestellteil">Bestellteil</option>
                                                <option value="arbeitsvorgang">Arbeitsvorgang</option>
                                                <option value="sonstiges">Sonstiges</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <!-- Platz für Löschen-Button bei dynamischen Unterpositionen -->
                                        </div>
                                    </div>
                                    
                                    <!-- Bestellteil Felder -->
                                    <div class="row mt-3 bestellteil-fields" id="bestellteil-1">
                                        <div class="col-md-3">
                                            <label class="form-label">Lieferant</label>
                                            <select name="sub_supplier[]" class="form-control">
                                                <option value="">Lieferant wählen</option>
                                                {% for supplier in suppliers %}
                                                <option value="{{ supplier.name }}">{{ supplier.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Lieferantenteilenummer</label>
                                            <input type="text" name="sub_part_number[]" class="form-control" 
                                                   placeholder="z.B. AB-12345">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Anzahl</label>
                                            <input type="text" name="sub_part_quantity[]" class="form-control" 
                                                   placeholder="z.B. 1, 2.5" value="1">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Preis für Kalkulation</label>
                                            <div class="input-group">
                                                <input type="number" name="sub_part_price[]" class="form-control sub-price-input" 
                                                       min="0" step="0.01" placeholder="0.00" onchange="calculateDetailedTotal()">
                                                <span class="input-group-text">€</span>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" name="sub_requires_order[]" value="1" checked>
                                                <label class="form-check-label">
                                                    Bestellung nötig
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Arbeitsvorgang Felder -->
                                    <div class="row mt-3 arbeitsvorgang-fields" id="arbeitsvorgang-1" style="display: none;">
                                        <div class="col-md-4">
                                            <label class="form-label">Stunden</label>
                                            <div class="input-group">
                                                <input type="text" name="sub_hours[]" class="form-control" 
                                                       placeholder="z.B. 2.5" onchange="calculateWorkPrice(this, 1)">
                                                <span class="input-group-text">h</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Stundensatz</label>
                                            <div class="input-group">
                                                <input type="number" name="sub_hourly_rate[]" class="form-control" 
                                                       value="{{ get_default_hourly_rate() }}" step="0.01" onchange="calculateWorkPrice(this, 1)">
                                                <span class="input-group-text">€</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Berechneter Preis</label>
                                            <div class="input-group">
                                                <input type="text" id="work-price-1" class="form-control sub-price-input" readonly>
                                                <span class="input-group-text">€</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Sonstiges Felder -->
                                    <div class="row mt-3 sonstiges-fields" id="sonstiges-1" style="display: none;">
                                        <div class="col-md-4">
                                            <label class="form-label">Anzahl</label>
                                            <input type="text" name="sub_quantity[]" class="form-control" 
                                                   placeholder="z.B. 1, 2.5, 10m²" onchange="calculateSonstigesPrice(this, 1)">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Einzelpreis</label>
                                            <div class="input-group">
                                                <input type="number" name="sub_unit_price[]" class="form-control" 
                                                       min="0" step="0.01" placeholder="0.00" onchange="calculateSonstigesPrice(this, 1)">
                                                <span class="input-group-text">€</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Gesamtpreis</label>
                                            <div class="input-group">
                                                <input type="text" id="sonstiges-price-1" class="form-control sub-price-input" readonly>
                                                <span class="input-group-text">€</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-secondary" onclick="addSubItem()">
                                    <i class="fas fa-plus"></i> Weitere Unterposition hinzufügen
                                </button>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save"></i> Detaillierte Position speichern
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Aktuelle Positionen -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Angebotspositionen</h5>
                {% if quote.status == 'Angenommen' %}
                <small class="text-warning">
                    <i class="fas fa-lock"></i> Angebot ist angenommen und kann nicht mehr bearbeitet werden
                </small>
                {% endif %}
            </div>
            <div class="card-body">
                {% if quote.quote_items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 80px;">Position</th>
                                <th>Beschreibung</th>
                                <th style="width: 100px;">Menge</th>
                                <th style="width: 120px;">Einzelpreis</th>
                                <th style="width: 120px;">Gesamtpreis</th>
                                <th style="width: 150px;">Details</th>
                                <th style="width: 100px;">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in quote.quote_items %}
                            <tr>
                                <td>
                                    <span class="badge bg-primary">{{ item.position_number or loop.index }}</span>
                                </td>
                                <td>
                                    <strong>{{ item.description }}</strong>
                                    
                                    <!-- Unterpositionen anzeigen -->
                                    {% if item.sub_items %}
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-info" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#subitems-{{ item.id }}" 
                                                aria-expanded="false">
                                            <i class="fas fa-list"></i> 
                                            {{ item.sub_items|length }} Unterpositionen anzeigen
                                        </button>
                                        <div class="collapse mt-2" id="subitems-{{ item.id }}">
                                            <div class="card card-body bg-light" style="font-size: 0.9em;">
                                                <table class="table table-sm mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th style="width: 80px;">Sub-Nr.</th>
                                                            <th>Beschreibung</th>
                                                            <th style="width: 100px;">Typ</th>
                                                            <th style="width: 120px;">Details</th>
                                                            <th style="width: 80px;">Preis</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for sub_item in item.sub_items %}
                                                        <tr>
                                                            <td>
                                                                <span class="badge bg-secondary">{{ sub_item.sub_number }}</span>
                                                            </td>
                                                            <td>{{ sub_item.description }}</td>
                                                            <td>
                                                                {% if sub_item.item_type == 'arbeitsvorgang' %}
                                                                <span class="badge bg-info">
                                                                    <i class="fas fa-tools"></i> Arbeit
                                                                </span>
                                                                {% elif sub_item.item_type == 'sonstiges' %}
                                                                <span class="badge bg-success">
                                                                    <i class="fas fa-cog"></i> Sonstiges
                                                                </span>
                                                                {% else %}
                                                                <span class="badge bg-warning text-dark">
                                                                    <i class="fas fa-shopping-cart"></i> Teil
                                                                </span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if sub_item.item_type == 'arbeitsvorgang' %}
                                                                <small class="text-muted">{{ sub_item.hours }} h × {{ sub_item.hourly_rate }}€</small>
                                                                {% elif sub_item.item_type == 'sonstiges' %}
                                                                <small class="text-muted">{{ sub_item.quantity }} × {{ sub_item.unit_price }}€</small>
                                                                {% else %}
                                                                <small class="text-muted">{{ sub_item.supplier or '-' }}</small>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if sub_item.price > 0 %}
                                                                <small class="text-muted">{{ "%.2f"|format(sub_item.price) }} €</small>
                                                                {% else %}
                                                                <small class="text-muted">-</small>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ "%.2f"|format(item.unit_price) }} €</td>
                                <td><strong>{{ "%.2f"|format(item.total_price) }} €</strong></td>
                                <td>
                                    {% if item.requires_order %}
                                    <span class="badge bg-warning text-dark mb-1">
                                        <i class="fas fa-shopping-cart"></i> Bestellung
                                    </span>
                                    {% endif %}
                                    {% if item.supplier %}
                                    <br><small class="text-muted">{{ item.supplier }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm">
                                        {% if quote.status != 'Angenommen' %}
                                        <a href="{{ url_for('edit_quote_item', id=quote.id, item_id=item.id) }}" 
                                           class="btn btn-outline-secondary btn-sm" 
                                           title="Position bearbeiten">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('remove_quote_item', id=quote.id, item_id=item.id) }}" 
                                           class="btn btn-outline-danger btn-sm"
                                           onclick="return confirm('Position {{ item.position_number or loop.index }} wirklich entfernen? Alle Unterpositionen gehen ebenfalls verloren.')"
                                           title="Löschen">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-lock"></i> Eingefroren
                                        </span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <th colspan="4" class="text-end">Nettosumme:</th>
                                <th id="footer-base-total">{{ "%.2f"|format(quote.calculate_net_total()) }} €</th>
                                <th></th>
                                <th></th>
                            </tr>
                            <tr class="table-light">
                                <th colspan="4" class="text-end">Aufschlag (<span id="footer-markup-percent">{{ quote.markup_percentage or 15 }}</span>%):</th>
                                <th id="footer-markup-amount">{{ "%.2f"|format(quote.calculate_markup_amount()) }} €</th>
                                <th></th>
                                <th></th>
                            </tr>
                            <tr class="table-success">
                                <th colspan="4" class="text-end">Gesamtsumme:</th>
                                <th id="footer-total-amount">{{ "%.2f"|format(quote.calculate_total()) }} €</th>
                                <th></th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Keine Positionen vorhanden</h5>
                    <p class="text-muted">Fügen Sie Produkte zu diesem Angebot hinzu.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Lieferanten-Daten für JavaScript -->
<script type="application/json" id="suppliers-data">
{{ suppliers | map(attribute='name') | list | tojson }}
</script>

<script>
// Lieferanten-Daten laden
var suppliers = JSON.parse(document.getElementById('suppliers-data').textContent);

// Funktion zum Erstellen der Lieferanten-Optionen
function createSupplierOptions() {
    let options = '<option value="">Lieferant wählen</option>';
    suppliers.forEach(supplier => {
        options += `<option value="${supplier}">${supplier}</option>`;
    });
    return options;
}

// Aufschlagsberechnung aktualisieren
function updateMarkupDisplay() {
    // Diese Funktion wird nur aufgerufen, wenn der Aufschlag geändert wird
    // Für korrekte Berechnungen bei Items mit Sub-Items ist ein Server-Request nötig
    // Vorerst deaktiviert - Benutzer muss Seite neu laden oder Angebot speichern
    console.log('Aufschlag geändert - bitte Angebot speichern um aktualisierte Werte zu sehen');
const baseTotalDisplay = document.getElementById('base-total-display');
const markupAmountDisplay = document.getElementById('markup-amount-display');
const totalAmountDisplay = document.getElementById('total-amount-display');

if (baseTotalDisplay) baseTotalDisplay.textContent = netTotal.toFixed(2) + ' €';
if (markupAmountDisplay) markupAmountDisplay.textContent = markupAmount.toFixed(2) + ' €';
if (totalAmountDisplay) totalAmountDisplay.textContent = totalAmount.toFixed(2) + ' €';

// Aktualisiere Footer der Tabelle
const footerBaseTotal = document.getElementById('footer-base-total');
const footerMarkupPercent = document.getElementById('footer-markup-percent');
const footerMarkupAmount = document.getElementById('footer-markup-amount');
const footerTotalAmount = document.getElementById('footer-total-amount');

if (footerBaseTotal) footerBaseTotal.textContent = netTotal.toFixed(2) + ' €';
if (footerMarkupPercent) footerMarkupPercent.textContent = markupPercent.toFixed(1);
if (footerMarkupAmount) footerMarkupAmount.textContent = markupAmount.toFixed(2) + ' €';
if (footerTotalAmount) footerTotalAmount.textContent = totalAmount.toFixed(2) + ' €';
}
 
// Angebot speichern
function saveQuote() {
    const form = document.getElementById('quote-edit-form');
    if (form.checkValidity()) {
        form.submit();
    } else {
        alert('Bitte füllen Sie alle Pflichtfelder aus.');
    }
}

// Arbeitsposition Funktionen
let selectedWorkSteps = [];
let workStepCounter = 0;

function toggleWorkStep(checkbox) {
    const category = checkbox.dataset.category;
    const step = checkbox.dataset.step;
    const defaultHours = parseFloat(checkbox.dataset.defaultHours);
    const hourlyRate = parseFloat(document.getElementById('work-hourly-rate').value) || 95;
    
    if (checkbox.checked) {
        // Arbeitsschritt hinzufügen
        workStepCounter++;
        const workStep = {
            id: workStepCounter,
            category: category,
            step: step,
            hours: defaultHours,
            rate: hourlyRate,
            price: defaultHours * hourlyRate
        };
        selectedWorkSteps.push(workStep);
        addWorkStepToList(workStep);
    } else {
        // Arbeitsschritt entfernen
        const stepId = selectedWorkSteps.findIndex(ws => ws.category === category && ws.step === step);
        if (stepId !== -1) {
            const workStep = selectedWorkSteps[stepId];
            selectedWorkSteps.splice(stepId, 1);
            removeWorkStepFromList(workStep.id);
        }
    }
    
    calculateWorkTotal();
}

function addWorkStepToList(workStep) {
    const container = document.getElementById('selected-work-steps');
    
    // Entferne "Keine Arbeitsschritte" Nachricht wenn erste hinzugefügt wird
    if (selectedWorkSteps.length === 1) {
        container.innerHTML = '';
    }
    
    const stepDiv = document.createElement('div');
    stepDiv.className = 'card mb-2';
    stepDiv.id = `work-step-${workStep.id}`;
    stepDiv.innerHTML = `
        <div class="card-body py-2">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <strong>${workStep.category}</strong><br>
                    <small class="text-muted">${workStep.step}</small>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Stunden</label>
                    <input type="number" 
                           class="form-control form-control-sm" 
                           value="${workStep.hours}" 
                           step="0.1" 
                           min="0.1"
                           onchange="updateWorkStepHours(${workStep.id}, this.value)"
                           name="work_step_hours[]">
                    <input type="hidden" name="work_step_categories[]" value="${workStep.category}">
                    <input type="hidden" name="work_step_names[]" value="${workStep.step}">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Stundensatz</label>
                    <div class="input-group input-group-sm">
                        <input type="number" 
                               class="form-control" 
                               value="${workStep.rate}" 
                               step="0.01"
                               onchange="updateWorkStepRate(${workStep.id}, this.value)"
                               name="work_step_rates[]">
                        <span class="input-group-text">€</span>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Preis</label>
                    <div class="input-group input-group-sm">
                        <input type="text" 
                               class="form-control" 
                               id="work-step-price-${workStep.id}"
                               value="${workStep.price.toFixed(2)}" 
                               readonly>
                        <span class="input-group-text">€</span>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" 
                            class="btn btn-outline-danger btn-sm" 
                            onclick="removeWorkStep(${workStep.id}, '${workStep.category}', '${workStep.step}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(stepDiv);
}

function removeWorkStepFromList(stepId) {
    const stepDiv = document.getElementById(`work-step-${stepId}`);
    if (stepDiv) {
        stepDiv.remove();
    }
    
    // Zeige "Keine Arbeitsschritte" Nachricht wenn alle entfernt wurden
    if (selectedWorkSteps.length === 0) {
        const container = document.getElementById('selected-work-steps');
        container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle"></i> Keine Arbeitsschritte ausgewählt
            </div>
        `;
    }
}

function updateWorkStepHours(stepId, newHours) {
    const workStep = selectedWorkSteps.find(ws => ws.id === stepId);
    if (workStep) {
        workStep.hours = parseFloat(newHours) || 0;
        workStep.price = workStep.hours * workStep.rate;
        document.getElementById(`work-step-price-${stepId}`).value = workStep.price.toFixed(2);
        calculateWorkTotal();
    }
}

function updateWorkStepRate(stepId, newRate) {
    const workStep = selectedWorkSteps.find(ws => ws.id === stepId);
    if (workStep) {
        workStep.rate = parseFloat(newRate) || 0;
        workStep.price = workStep.hours * workStep.rate;
        document.getElementById(`work-step-price-${stepId}`).value = workStep.price.toFixed(2);
        calculateWorkTotal();
    }
}

function removeWorkStep(stepId, category, step) {
    // Entferne aus Array
    const index = selectedWorkSteps.findIndex(ws => ws.id === stepId);
    if (index !== -1) {
        selectedWorkSteps.splice(index, 1);
    }
    
    // Entferne aus Liste
    removeWorkStepFromList(stepId);
    
    // Uncheck checkbox
    const checkbox = document.querySelector(`input[data-category="${category}"][data-step="${step}"]`);
    if (checkbox) {
        checkbox.checked = false;
    }
    
    calculateWorkTotal();
}

function calculateWorkTotal() {
    const total = selectedWorkSteps.reduce((sum, step) => sum + step.price, 0);
    const totalDisplay = document.getElementById('calculated-work-total');
    if (totalDisplay) {
        totalDisplay.value = total.toFixed(2);
    }
}

// Einfache Position Berechnung
function calculateSimpleTotal() {
    const quantity = parseFloat(document.querySelector('input[name="quantity"]').value) || 0;
    const unitPrice = parseFloat(document.querySelector('input[name="unit_price"]').value) || 0;
    const totalDisplay = document.getElementById('simple-calculated-total');
    
    if (quantity > 0 && unitPrice >= 0) {
        const total = quantity * unitPrice;
        totalDisplay.value = total.toFixed(2);
    } else {
        totalDisplay.value = '0.00';
    }
}

// Detaillierte Position Berechnung
function calculateDetailedTotal() {
    let total = 0;
    
    // Bestellteil-Preise
    const partPriceInputs = document.querySelectorAll('input[name="sub_part_price[]"]');
    partPriceInputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
    });
    
    // Arbeitsvorgang-Preise (bereits berechnete Werte)
    const workPriceInputs = document.querySelectorAll('[id^="work-price-"]');
    workPriceInputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
    });
    
    // Sonstiges-Preise (bereits berechnete Werte)
    const sonstigesPriceInputs = document.querySelectorAll('[id^="sonstiges-price-"]');
    sonstigesPriceInputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
    });
    
    const totalDisplay = document.getElementById('calculated-detail-total');
    if (totalDisplay) {
        totalDisplay.value = total.toFixed(2);
    }
}

// Weitere Unterposition hinzufügen
function addSubItem() {
    const container = document.getElementById('sub-items-container');
    const index = container.children.length + 1; // Eindeutigen Index generieren
    
    const newSubItem = document.createElement('div');
    newSubItem.className = 'sub-item-row border rounded p-3 mb-3';
    newSubItem.style.backgroundColor = '#f8f9fa';
    newSubItem.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Unterposition Beschreibung</label>
                <input type="text" name="sub_description[]" class="form-control" 
                       placeholder="z.B. Mineralguß Duschtasse 170x80cm">
            </div>
            <div class="col-md-3">
                <label class="form-label">Typ</label>
                <select name="sub_item_type[]" class="form-control" onchange="toggleSubItemFields(this, ${index})">
                    <option value="bestellteil">Bestellteil</option>
                    <option value="arbeitsvorgang">Arbeitsvorgang</option>
                    <option value="sonstiges">Sonstiges</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-danger btn-sm mt-4 w-100" onclick="removeSubItem(this)">
                    <i class="fas fa-trash"></i> Löschen
                </button>
            </div>
        </div>
        
        <!-- Bestellteil Felder -->
        <div class="row mt-3 bestellteil-fields" id="bestellteil-${index}">
            <div class="col-md-3">
                <label class="form-label">Lieferant</label>
                <select name="sub_supplier[]" class="form-control">
                    ${createSupplierOptions()}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Lieferantenteilenummer</label>
                <input type="text" name="sub_part_number[]" class="form-control" 
                       placeholder="z.B. AB-12345">
            </div>
            <div class="col-md-2">
                <label class="form-label">Anzahl</label>
                <input type="text" name="sub_part_quantity[]" class="form-control" 
                       placeholder="z.B. 1, 2.5" value="1">
            </div>
            <div class="col-md-2">
                <label class="form-label">Preis für Kalkulation</label>
                <div class="input-group">
                    <input type="number" name="sub_part_price[]" class="form-control sub-price-input" 
                           min="0" step="0.01" placeholder="0.00" onchange="calculateDetailedTotal()">
                    <span class="input-group-text">€</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" name="sub_requires_order[]" value="${index}" checked>
                    <label class="form-check-label">
                        Bestellung nötig
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Arbeitsvorgang Felder -->
        <div class="row mt-3 arbeitsvorgang-fields" id="arbeitsvorgang-${index}" style="display: none;">
            <div class="col-md-4">
                <label class="form-label">Stunden</label>
                <div class="input-group">
                    <input type="text" name="sub_hours[]" class="form-control" 
                           placeholder="z.B. 2.5" onchange="calculateWorkPrice(this, ${index})">
                    <span class="input-group-text">h</span>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Stundensatz</label>
                <div class="input-group">
                    <input type="number" name="sub_hourly_rate[]" class="form-control" 
                           value="{{ get_default_hourly_rate() }}" step="0.01" onchange="calculateWorkPrice(this, ${index})">
                    <span class="input-group-text">€</span>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Berechneter Preis</label>
                <div class="input-group">
                    <input type="text" id="work-price-${index}" class="form-control sub-price-input" readonly>
                    <span class="input-group-text">€</span>
                </div>
            </div>
        </div>
        
        <!-- Sonstiges Felder -->
        <div class="row mt-3 sonstiges-fields" id="sonstiges-${index}" style="display: none;">
            <div class="col-md-4">
                <label class="form-label">Anzahl</label>
                <input type="text" name="sub_quantity[]" class="form-control" 
                       placeholder="z.B. 1, 2.5, 10m²" onchange="calculateSonstigesPrice(this, ${index})">
            </div>
            <div class="col-md-4">
                <label class="form-label">Einzelpreis</label>
                <div class="input-group">
                    <input type="number" name="sub_unit_price[]" class="form-control" 
                           min="0" step="0.01" placeholder="0.00" onchange="calculateSonstigesPrice(this, ${index})">
                    <span class="input-group-text">€</span>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Gesamtpreis</label>
                <div class="input-group">
                    <input type="text" id="sonstiges-price-${index}" class="form-control sub-price-input" readonly>
                    <span class="input-group-text">€</span>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(newSubItem);
}

// Umschalten zwischen Bestellteil, Arbeitsvorgang und Sonstiges
function toggleSubItemFields(select, index) {
    const bestellteilFields = document.getElementById(`bestellteil-${index}`);
    const arbeitsvorgangFields = document.getElementById(`arbeitsvorgang-${index}`);
    const sonstigesFields = document.getElementById(`sonstiges-${index}`);
    
    // Alle Felder ausblenden
    if (bestellteilFields) bestellteilFields.style.display = 'none';
    if (arbeitsvorgangFields) arbeitsvorgangFields.style.display = 'none';
    if (sonstigesFields) sonstigesFields.style.display = 'none';
    
    // Entsprechende Felder einblenden
    if (select.value === 'arbeitsvorgang' && arbeitsvorgangFields) {
        arbeitsvorgangFields.style.display = 'block';
    } else if (select.value === 'sonstiges' && sonstigesFields) {
        sonstigesFields.style.display = 'block';
    } else if (bestellteilFields) { // bestellteil (default)
        bestellteilFields.style.display = 'block';
    }
    
    calculateDetailedTotal();
}

// Arbeitszeit-Preis berechnen
function calculateWorkPrice(input, index) {
    const row = input.closest('.arbeitsvorgang-fields');
    const hoursInput = row.querySelector('input[name="sub_hours[]"]');
    const rateInput = row.querySelector('input[name="sub_hourly_rate[]"]');
    const priceDisplay = document.getElementById(`work-price-${index}`);
    
    const hours = parseFloat(hoursInput.value) || 0;
    const rate = parseFloat(rateInput.value) || 95;
    
    const total = hours * rate;
    priceDisplay.value = total.toFixed(2);
    
    calculateDetailedTotal();
}

// Sonstiges-Preis berechnen (Anzahl × Einzelpreis)
function calculateSonstigesPrice(input, index) {
    const row = input.closest('.sonstiges-fields');
    const quantityInput = row.querySelector('input[name="sub_quantity[]"]');
    const unitPriceInput = row.querySelector('input[name="sub_unit_price[]"]');
    const priceDisplay = document.getElementById(`sonstiges-price-${index}`);
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const unitPrice = parseFloat(unitPriceInput.value) || 0;
    
    const total = quantity * unitPrice;
    priceDisplay.value = total.toFixed(2);
    
    calculateDetailedTotal();
}

function removeSubItem(button) {
    button.closest('.sub-item-row').remove();
    calculateDetailedTotal(); // Gesamtpreis neu berechnen
}

// Template-System (entfernt - nur Platzhalter für künftige Erweiterungen)
let templateData = {};

// Template-Selector Funktionen
function openTemplateSelector() {
    const url = `/quotes/{{ quote.id }}/template-selector`;
    const popup = window.open(url, 'templateSelector', 'width=1200,height=800,scrollbars=yes,resizable=yes');
    
    if (!popup) {
        alert('Popup wurde blockiert. Bitte erlauben Sie Popups für diese Seite.');
        return;
    }
    
    // Focus auf das Popup setzen
    popup.focus();
}

function addSelectedTemplate() {
    if (!selectedTemplateData) {
        alert('Keine Vorlage ausgewählt.');
        return;
    }
    
    // AJAX-Call zum Hinzufügen der Vorlage
    fetch(`/quotes/{{ quote.id }}/add_template`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({
            template_id: selectedTemplateData.templateId,
            calculation_parameters: selectedTemplateData.calculations
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Erfolgsmeldung anzeigen
            showQuoteAlert('success', `Vorlage wurde als Position ${data.position_number} hinzugefügt!`);
            
            // Template-Selection zurücksetzen
            clearSelectedTemplate();
            
            // Seite nach kurzer Verzögerung neu laden
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showQuoteAlert('danger', 'Fehler beim Hinzufügen der Vorlage: ' + data.message);
        }
    })
    .catch(error => {
        showQuoteAlert('danger', 'Fehler beim Hinzufügen der Vorlage: ' + error);
    });
}

function clearSelectedTemplate() {
    selectedTemplateData = null;
    document.getElementById('selectedTemplateInfo').style.display = 'none';
}

function showQuoteAlert(type, message) {
    // Erstelle Alert-Element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Füge Alert am Anfang der Seite hinzu
    const container = document.querySelector('.row').parentNode;
    container.insertBefore(alertDiv, container.firstChild);
    
    // Automatisch nach 5 Sekunden ausblenden
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// PostMessage Listener für Template-Selector
let selectedTemplateData = null;

window.addEventListener('message', function(event) {
    // Sicherheitscheck: nur von derselben Origin
    if (event.origin !== window.location.origin) {
        return;
    }
    
    if (event.data.type === 'TEMPLATE_SELECTED') {
        selectedTemplateData = event.data.data;
        
        // Template-Info anzeigen
        document.getElementById('selectedTemplateInfo').style.display = 'block';
        document.getElementById('templateInfoName').textContent = `Vorlage ${selectedTemplateData.templateId}`;
        document.getElementById('templateInfoLength').textContent = selectedTemplateData.calculations.length || '0';
        document.getElementById('templateInfoWidth').textContent = selectedTemplateData.calculations.width || '0';
        document.getElementById('templateInfoHeight').textContent = selectedTemplateData.calculations.height || '0';
        document.getElementById('templateInfoHours').textContent = selectedTemplateData.calculations.hours || '0';
        document.getElementById('templateInfoArea').textContent = selectedTemplateData.calculations.area?.toFixed(2) || '0.00';
        document.getElementById('templateInfoPrice').textContent = selectedTemplateData.calculations.calculatedPrice?.toFixed(2) + '€' || '0.00€';
        
        showQuoteAlert('info', 'Vorlage ausgewählt! Klicken Sie auf "Position hinzufügen" um sie zu verwenden.');
        
    } else if (event.data.type === 'TEMPLATE_ADDED_AND_REFRESH') {
        // Neue elegante Lösung: Direktes Update ohne Refresh
        console.log('Template hinzugefügt:', event.data.templateData);
        
        // Zeige Erfolgs-Alert
        showQuoteAlert('success', event.data.message || 'Vorlage wurde erfolgreich hinzugefügt!');
        
        // Automatisch die Seite neu laden, um die neuen Positionen anzuzeigen
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } else if (event.data.type === 'template_added') {
        // Fallback für alte Implementierung
        console.log('Template hinzugefügt (legacy):', event.data.data);
        showQuoteAlert('success', event.data.message || 'Vorlage wurde hinzugefügt!');
        
        // Kurze Verzögerung, dann Refresh
        setTimeout(() => {
            window.location.reload();
        }, 1000);
        
    } else if (event.data.type === 'TEMPLATE_CANCELLED') {
        // Nichts tun, Popup wurde geschlossen
        console.log('Template-Auswahl abgebrochen');
    }
});

// Beim Laden der Seite
document.addEventListener('DOMContentLoaded', function() {
    calculateSimpleTotal();
    calculateDetailedTotal();
    updateMarkupDisplay(); // Initial berechnen
    
    // Enter-Taste in Eingabefeldern deaktivieren (verhindert ungewolltes Speichern)
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && event.target.tagName === 'INPUT' && event.target.type !== 'submit') {
            event.preventDefault();
            return false;
        }
    });
    
    // Tab-Wechsel Events
    document.querySelectorAll('#addPositionTabs button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            if (event.target.id === 'detailed-tab') {
                calculateDetailedTotal();
                updateMarkupDisplay();
            }
        });
    });
});
</script>

{% endblock %}
