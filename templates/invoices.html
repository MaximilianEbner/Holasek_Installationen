{% extends "base.html" %}

{% block title %}Rechnungen{% endblock %}

{% block extra_css %}
<style>
/* Auftragssuche Dropdown Styling */
#order_dropdown {
    display: none;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    background: white;
}

#order_dropdown .dropdown-item {
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #f8f9fa;
    cursor: pointer;
}

#order_dropdown .dropdown-item:hover {
    background-color: #f8f9fa;
}

#order_dropdown .dropdown-item:last-child {
    border-bottom: none;
}

#order_dropdown .dropdown-item-text {
    padding: 0.5rem 1rem;
    color: #6c757d;
}

/* Harmonische Tabellen-Styling */
.table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.table th {
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
    padding: 1rem 0.75rem;
}

/* Status-Badge-Styling */
.badge {
    font-size: 0.85em;
    font-weight: 500;
}

/* Button-Gruppe kompakter */
.btn-group .btn-sm {
    padding: 0.25rem 0.5rem;
}

/* Dashboard-Karten Hover-Effekt */
.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

/* Responsive Dashboard */
@media (max-width: 768px) {
    .card-body {
        padding: 1.5rem 1rem !important;
    }
    
    .card-title {
        font-size: 0.8rem !important;
    }
    
    .card h3 {
        font-size: 1.5rem !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Rechnungsübersicht</h2>
    <div>
        <a href="{{ url_for('new_invoice') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Neue Rechnung
        </a>
    </div>
</div>

<!-- Statistiken Dashboard -->
<div class="row mb-4 g-3">
    <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);">
            <div class="card-body text-white text-center py-4">
                <div class="mb-2">
                    <i class="bi bi-clock-history" style="font-size: 2rem; opacity: 0.8;"></i>
                </div>
                <h5 class="card-title mb-1" style="font-size: 0.9rem; font-weight: 600;">Offene Rechnungen</h5>
                <h3 class="mb-0" style="font-weight: 700;">{{ stats.open_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
            <div class="card-body text-white text-center py-4">
                <div class="mb-2">
                    <i class="bi bi-pie-chart-fill" style="font-size: 2rem; opacity: 0.8;"></i>
                </div>
                <h5 class="card-title mb-1" style="font-size: 0.9rem; font-weight: 600;">Teilweise bezahlt</h5>
                <h3 class="mb-1" style="font-weight: 700;">{{ stats.partially_paid_count }}</h3>
                <small style="opacity: 0.9; font-size: 0.8rem;">{{ stats.total_partial_paid|currency }}</small>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            <div class="card-body text-white text-center py-4">
                <div class="mb-2">
                    <i class="bi bi-check-circle-fill" style="font-size: 2rem; opacity: 0.8;"></i>
                </div>
                <h5 class="card-title mb-1" style="font-size: 0.9rem; font-weight: 600;">Bezahlte Rechnungen</h5>
                <h3 class="mb-0" style="font-weight: 700;">{{ stats.paid_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6">
        <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
            <div class="card-body text-white text-center py-4">
                <div class="mb-2">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem; opacity: 0.8;"></i>
                </div>
                <h5 class="card-title mb-1" style="font-size: 0.9rem; font-weight: 600;">Überfällige Rechnungen</h5>
                <h3 class="mb-0" style="font-weight: 700;">{{ stats.overdue_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-8 col-sm-12">
        <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
            <div class="card-body text-white text-center py-4">
                <div class="mb-2">
                    <i class="bi bi-currency-euro" style="font-size: 2rem; opacity: 0.8;"></i>
                </div>
                <h5 class="card-title mb-1" style="font-size: 0.9rem; font-weight: 600;">Bezahlter Gesamtbetrag</h5>
                <h3 class="mb-1" style="font-weight: 700;">{{ stats.total_amount|currency }}</h3>
                {% if stats.total_partial_paid > 0 %}
                <small style="opacity: 0.9; font-size: 0.8rem;">+ {{ stats.total_partial_paid|currency }} teilweise</small>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Filter und Suche -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Suche</label>
                <div class="input-group">
                    <input type="text" name="search" class="form-control" placeholder="Rechnungsnummer, Kunde..." value="{{ request.args.get('search', '') }}">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select auto-submit">
                    <option value="">Alle Status</option>
                    <option value="erstellt" {{ 'selected' if request.args.get('status') == 'erstellt' }}>Erstellt</option>
                    <option value="versendet" {{ 'selected' if request.args.get('status') == 'versendet' }}>Versendet</option>
                    <option value="teilweise_bezahlt" {{ 'selected' if request.args.get('status') == 'teilweise_bezahlt' }}>Teilweise bezahlt</option>
                    <option value="bezahlt" {{ 'selected' if request.args.get('status') == 'bezahlt' }}>Bezahlt</option>
                    <option value="ueberfaellig" {{ 'selected' if request.args.get('status') == 'ueberfaellig' }}>Überfällig</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Typ</label>
                <select name="invoice_type" class="form-select auto-submit">
                    <option value="">Alle Typen</option>
                    <option value="anzahlung" {{ 'selected' if request.args.get('invoice_type') == 'anzahlung' }}>Anzahlung</option>
                    <option value="schluss" {{ 'selected' if request.args.get('invoice_type') == 'schluss' }}>Schlussrechnung</option>
                    <option value="detailed_final" {{ 'selected' if request.args.get('invoice_type') == 'detailed_final' }}>Detaillierte Schlussrechnung</option>
                    <option value="allgemein" {{ 'selected' if request.args.get('invoice_type') == 'allgemein' }}>Allgemeine Rechnung</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Zeitraum</label>
                <select name="period" class="form-select auto-submit">
                    <option value="">Alle Zeiträume</option>
                    <option value="today" {{ 'selected' if request.args.get('period') == 'today' }}>Heute</option>
                    <option value="week" {{ 'selected' if request.args.get('period') == 'week' }}>Diese Woche</option>
                    <option value="month" {{ 'selected' if request.args.get('period') == 'month' }}>Dieser Monat</option>
                    <option value="quarter" {{ 'selected' if request.args.get('period') == 'quarter' }}>Dieses Quartal</option>
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Rechnungstabelle -->
<div class="card">
    <div class="card-body">
        {% if invoices.items %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th style="width: 15%;">Rechnungsnummer</th>
                        <th style="width: 18%;">Kunde</th>
                        <th style="width: 12%;">Typ</th>
                        <th style="width: 15%;" class="text-end">Betrag</th>
                        <th style="width: 12%;">Fällig am</th>
                        <th style="width: 13%;">Status</th>
                        <th style="width: 10%;">Erstellt am</th>
                        <th style="width: 5%;" class="text-center">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices.items %}
                    <tr>
                        <td>
                            <strong>{{ invoice.invoice_number }}</strong><br>
                            {% if invoice.order %}
                                <small class="text-muted">{{ invoice.order.order_number }}</small>
                            {% else %}
                                <small class="text-muted">Allgemeine Rechnung</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if invoice.order %}
                                <strong>{{ invoice.order.quote.customer.full_name }}</strong><br>
                                <small class="text-muted">{{ invoice.order.quote.customer.city or '' }}</small>
                            {% elif invoice.customer %}
                                <strong>{{ invoice.customer.full_name }}</strong><br>
                                <small class="text-muted">{{ invoice.customer.city or '' }}</small>
                            {% else %}
                                <span class="text-muted">Unbekannter Kunde</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">
                                {{ invoice.get_type_display() }}
                            </span><br>
                            <small class="text-muted">{{ invoice.percentage }}%</small>
                        </td>
                        <td class="text-end">
                            <strong class="text-dark">{{ invoice.gross_amount|currency }}</strong><br>
                            <small class="text-muted">netto: {{ invoice.final_amount|currency }}</small>
                            {% if invoice.status == 'teilweise_bezahlt' and invoice.paid_amount %}
                            <br><small class="text-success fw-bold">bezahlt: {{ invoice.paid_amount|currency }} ({{ "%.0f"|format(invoice.get_payment_percentage()) }}%)</small>
                            <br><small class="text-warning fw-bold">offen: {{ invoice.get_remaining_amount()|currency }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="fw-bold">{{ invoice.due_date.strftime('%d.%m.%Y') }}</span>
                            {% if invoice.is_overdue() %}
                            <br><small class="text-danger fw-bold"><i class="bi bi-exclamation-triangle"></i> {{ invoice.days_overdue() }} Tage überfällig</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {{ invoice.get_status_badge_class() }} px-3 py-2">
                                {{ invoice.status.replace('_', ' ').title() }}
                            </span>
                        </td>
                        <td><span class="text-muted">{{ invoice.created_at.strftime('%d.%m.%Y') }}</span></td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <!-- Details anzeigen -->
                                <a href="{{ url_for('invoice_details', id=invoice.id) }}" 
                                   class="btn btn-outline-primary btn-sm" 
                                   title="Details anzeigen">
                                    <i class="bi bi-eye"></i>
                                </a>
                                
                                <!-- PDF Download -->
                                <a href="{{ url_for('download_invoice_pdf', id=invoice.id) }}" 
                                   class="btn btn-outline-danger btn-sm" 
                                   title="PDF herunterladen">
                                    <i class="bi bi-file-pdf"></i>
                                </a>
                                
                                <!-- Status ändern -->
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-success btn-sm dropdown-toggle" 
                                            data-bs-toggle="dropdown" 
                                            title="Status ändern">
                                        <i class="bi bi-gear"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <!-- Vorwärts-Status -->
                                        {% if invoice.status == 'erstellt' %}
                                        <li><a class="dropdown-item" href="#" onclick="updateInvoiceStatus('{{ invoice.id }}', 'versendet')">
                                            <i class="bi bi-send"></i> Als versendet markieren</a></li>
                                        {% endif %}
                                        {% if invoice.status in ['erstellt', 'versendet', 'teilweise_bezahlt'] %}
                                        <li><a class="dropdown-item" href="#" onclick="markAsPartiallyPaid('{{ invoice.id }}')">
                                            <i class="bi bi-cash-coin"></i> Als teilweise bezahlt markieren</a></li>
                                        {% endif %}
                                        {% if invoice.status in ['erstellt', 'versendet', 'teilweise_bezahlt'] %}
                                        <li><a class="dropdown-item" href="#" onclick="markAsPaid('{{ invoice.id }}')">
                                            <i class="bi bi-check-circle"></i> Als vollständig bezahlt markieren</a></li>
                                        {% endif %}
                                        
                                        <!-- Retour-Status -->
                                        {% if invoice.status == 'bezahlt' %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-info" href="#" onclick="updateInvoiceStatus('{{ invoice.id }}', 'teilweise_bezahlt')">
                                            <i class="bi bi-arrow-left"></i> Zurück zu "Teilweise bezahlt"</a></li>
                                        <li><a class="dropdown-item text-warning" href="#" onclick="updateInvoiceStatus('{{ invoice.id }}', 'versendet')">
                                            <i class="bi bi-arrow-left"></i> Zurück zu "Versendet"</a></li>
                                        {% endif %}
                                        {% if invoice.status == 'teilweise_bezahlt' %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-warning" href="#" onclick="updateInvoiceStatus('{{ invoice.id }}', 'versendet')">
                                            <i class="bi bi-arrow-left"></i> Zurück zu "Versendet"</a></li>
                                        {% endif %}
                                        {% if invoice.status == 'versendet' %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-secondary" href="#" onclick="updateInvoiceStatus('{{ invoice.id }}', 'erstellt')">
                                            <i class="bi bi-arrow-left"></i> Zurück zu "Erstellt"</a></li>
                                        {% endif %}
                                    </ul>
                                </div>
                                
                                <!-- Löschen (nur wenn nicht bezahlt oder teilweise bezahlt) -->
                                {% if invoice.status not in ['bezahlt', 'teilweise_bezahlt'] %}
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="deleteInvoice('{{ invoice.id }}')"
                                        title="Rechnung löschen">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if invoices.pages > 1 %}
        <nav aria-label="Rechnungen Pagination">
            <ul class="pagination justify-content-center">
                {% if invoices.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('invoices', page=invoices.prev_num, **request.args) }}">Zurück</a>
                </li>
                {% endif %}
                
                {% for page_num in invoices.iter_pages() %}
                {% if page_num %}
                {% if page_num != invoices.page %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('invoices', page=page_num, **request.args) }}">{{ page_num }}</a>
                </li>
                {% else %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% endif %}
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">…</span>
                </li>
                {% endif %}
                {% endfor %}
                
                {% if invoices.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('invoices', page=invoices.next_num, **request.args) }}">Weiter</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-receipt" style="font-size: 3rem; color: #ccc;"></i>
            <h4 class="mt-3 text-muted">Keine Rechnungen gefunden</h4>
            <p class="text-muted">Erstellen Sie Ihre erste Rechnung über die Auftragsübersicht.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal: Als bezahlt markieren -->
<div class="modal fade" id="markPaidModal" tabindex="-1" aria-labelledby="markPaidModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="markPaidModalLabel">Rechnung als vollständig bezahlt markieren</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="markPaidForm">
                <div class="modal-body">
                    <input type="hidden" id="paid_invoice_id" name="invoice_id">
                    
                    <div class="mb-3">
                        <label for="paid_date" class="form-label">Bezahldatum</label>
                        <input type="date" name="paid_date" id="paid_date" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_reference" class="form-label">Zahlungsreferenz</label>
                        <input type="text" name="payment_reference" id="payment_reference" class="form-control" placeholder="z.B. Überweisungsreferenz">
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_comment" class="form-label">Kommentar</label>
                        <textarea name="comment" id="payment_comment" class="form-control" rows="2" placeholder="Optional: Zusätzliche Informationen"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-success">Als vollständig bezahlt markieren</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Als teilweise bezahlt markieren -->
<div class="modal fade" id="markPartiallyPaidModal" tabindex="-1" aria-labelledby="markPartiallyPaidModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="markPartiallyPaidModalLabel">Rechnung als teilweise bezahlt markieren</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="markPartiallyPaidForm">
                <div class="modal-body">
                    <input type="hidden" id="partially_paid_invoice_id" name="invoice_id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Rechnungsbetrag (brutto)</label>
                            <div class="form-control-plaintext" id="invoice_total_amount">0,00 €</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Bereits bezahlt</label>
                            <div class="form-control-plaintext" id="already_paid_amount">0,00 €</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="partial_paid_amount" class="form-label">Bezahlter Betrag <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="number" name="paid_amount" id="partial_paid_amount" class="form-control" 
                                   step="0.01" min="0.01" placeholder="0,00" required>
                            <span class="input-group-text">€</span>
                        </div>
                        <div class="form-text">Geben Sie den tatsächlich bezahlten Betrag ein.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="partial_paid_date" class="form-label">Bezahldatum</label>
                        <input type="date" name="paid_date" id="partial_paid_date" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label for="partial_payment_reference" class="form-label">Zahlungsreferenz</label>
                        <input type="text" name="payment_reference" id="partial_payment_reference" class="form-control" placeholder="z.B. Überweisungsreferenz">
                    </div>
                    
                    <div class="mb-3">
                        <label for="partial_payment_comment" class="form-label">Kommentar zur Teilzahlung</label>
                        <textarea name="comment" id="partial_payment_comment" class="form-control" rows="2" placeholder="Optional: Zusätzliche Informationen zur Teilzahlung"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-info">Als teilweise bezahlt markieren</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Rechnung erstellen - nur wenn das Element existiert
const createInvoiceForm = document.getElementById('createInvoiceForm');
if (createInvoiceForm) {
    createInvoiceForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const invoiceType = document.getElementById('invoice_type').value;
        const orderIdField = document.getElementById('order_id');
        const orderSearchField = document.getElementById('order_search');
        const customerSelectField = document.getElementById('customer_select');
        const baseAmountField = document.getElementById('base_amount');
        
        // Validierung basierend auf Rechnungstyp
        if (invoiceType === 'allgemein') {
            // Allgemeine Rechnung: Kunde und Betrag erforderlich
            if (!customerSelectField.value) {
                alert('Bitte wählen Sie einen Kunden aus.');
                customerSelectField.focus();
                return;
            }
            if (!baseAmountField.value || parseFloat(baseAmountField.value) <= 0) {
                alert('Bitte geben Sie einen gültigen Rechnungsbetrag ein.');
                baseAmountField.focus();
                return;
            }
        } else {
            // Anzahlung/Schluss: Auftrag erforderlich
            if (!orderIdField.value) {
                alert('Bitte wählen Sie einen Auftrag aus.');
                orderSearchField.focus();
                return;
            }
        }
        
        const formData = new FormData(this);
        
        fetch('{{ url_for("create_invoice") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            alert('Ein Fehler ist aufgetreten: ' + error);
        });
    });
}

// Als bezahlt markieren
function markAsPaid(invoiceId) {
    document.getElementById('paid_invoice_id').value = invoiceId;
    // Datum auf heute setzen wenn Modal geöffnet wird
    setTodaysDateForModals();
    new bootstrap.Modal(document.getElementById('markPaidModal')).show();
}

const markPaidForm = document.getElementById('markPaidForm');
if (markPaidForm) {
    markPaidForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const invoiceId = document.getElementById('paid_invoice_id').value;
        const formData = new FormData(this);
        
        fetch(`/invoices/${invoiceId}/mark_paid`, {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Modal schließen
                bootstrap.Modal.getInstance(document.getElementById('markPaidModal')).hide();
                // Seite neu laden
                location.reload();
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            alert('Ein Fehler ist aufgetreten: ' + error);
        });
    });
}

// Als teilweise bezahlt markieren
function markAsPartiallyPaid(invoiceId) {
    // Lade Rechnungsdaten für das Modal
    fetch(`/api/invoice/${invoiceId}/payment_info`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('partially_paid_invoice_id').value = invoiceId;
            document.getElementById('invoice_total_amount').textContent = data.gross_amount.toFixed(2).replace('.', ',') + ' €';
            document.getElementById('already_paid_amount').textContent = (data.paid_amount || 0).toFixed(2).replace('.', ',') + ' €';
            
            // Max-Wert für den Input setzen (Gesamtbetrag - bereits bezahlt)
            const remainingAmount = data.gross_amount - (data.paid_amount || 0);
            document.getElementById('partial_paid_amount').setAttribute('max', remainingAmount.toFixed(2));
            document.getElementById('partial_paid_amount').value = '';
            
            // Datum auf heute setzen wenn Modal geöffnet wird
            setTodaysDateForModals();
            
            new bootstrap.Modal(document.getElementById('markPartiallyPaidModal')).show();
        } else {
            alert('Fehler beim Laden der Rechnungsdaten: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ein Fehler ist aufgetreten: ' + error);
    });
}

const markPartiallyPaidForm = document.getElementById('markPartiallyPaidForm');
if (markPartiallyPaidForm) {
    markPartiallyPaidForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const invoiceId = document.getElementById('partially_paid_invoice_id').value;
        const paidAmount = parseFloat(document.getElementById('partial_paid_amount').value);
        const maxAmount = parseFloat(document.getElementById('partial_paid_amount').getAttribute('max'));
        
        // Validierung
        if (isNaN(paidAmount) || paidAmount <= 0) {
            alert('Bitte geben Sie einen gültigen bezahlten Betrag ein.');
            return;
        }
        
        if (paidAmount > maxAmount) {
            alert(`Der bezahlte Betrag kann nicht höher als der offene Betrag (${maxAmount.toFixed(2)} €) sein.`);
            return;
        }
        
        const formData = new FormData(this);
        
        fetch(`/invoices/${invoiceId}/mark_partially_paid`, {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (response.ok) {
                return response.json();
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                // Modal schließen
                bootstrap.Modal.getInstance(document.getElementById('markPartiallyPaidModal')).hide();
                // Seite neu laden
                location.reload();
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Ein Fehler ist aufgetreten: ' + error);
        });
    });
}

// Status aktualisieren
function updateInvoiceStatus(invoiceId, newStatus) {
    fetch(`/invoices/${invoiceId}/update_status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({status: newStatus})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Fehler: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ein Fehler ist aufgetreten: ' + error);
    });
}

// Rechnung löschen
function deleteInvoice(invoiceId) {
    if (confirm('Sind Sie sicher, dass Sie diese Rechnung löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.')) {
        fetch(`/invoices/${invoiceId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Rechnung wurde erfolgreich gelöscht.');
                location.reload();
            } else {
                alert('Fehler beim Löschen: ' + data.message);
            }
        })
        .catch(error => {
            alert('Ein Fehler ist aufgetreten: ' + error);
        });
    }
}

// Fälligkeitsdatum automatisch setzen (falls existent)
if (document.getElementById('due_date')) {
    document.getElementById('due_date').valueAsDate = new Date(Date.now() + 0 * 24 * 60 * 60 * 1000);
}

// Bezahldatum auf heute setzen (deutsches Format)
function setTodaysDateForModals() {
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    const dateString = `${year}-${month}-${day}`; // HTML input format: yyyy-mm-dd
    
    // Für alle Datum-Felder in den Modals
    const dateFields = ['paid_date', 'partial_paid_date'];
    dateFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = dateString;
        }
    });
}

// Beim Laden der Seite das heutige Datum setzen
setTodaysDateForModals();

// Filter-Dropdowns aktivieren - automatisches Abschicken bei Änderung
// Auto-Submit für Filter-Dropdowns
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.querySelector('form[method="GET"]');
    if (filterForm) {
        // Alle Dropdown-Felder automatisch abschicken bei Änderung
        const filterSelects = filterForm.querySelectorAll('select.auto-submit');
        
        filterSelects.forEach(select => {
            select.addEventListener('change', function() {
                filterForm.submit();
            });
        });
    }
});
</script>
{% endblock %}
