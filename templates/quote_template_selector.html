{% extends "base.html" %}

{% block title %}Positionsvorlage auswählen - {{ quote.customer.last_name }}{% endblock %}

{% block extra_css %}
<style>
/* Template Navigation Styling */
.template-nav-item {
    border: none !important;
    border-radius: 0 !important;
    transition: all 0.2s ease;
}

.template-nav-item:hover {
    background-color: #f8f9fa !important;
    transform: translateX(5px);
}

.template-nav-item.active {
    background-color: #007bff !important;
    color: white !important;
    border-left: 4px solid #0056b3 !important;
}

.template-nav-item.active small {
    color: rgba(255, 255, 255, 0.8) !important;
}

.template-nav-item.active .badge {
    background-color: rgba(255, 255, 255, 0.2) !important;
}

/* Verstecke die Standard-Sidebar für Template-Selector */
.sidebar {
    display: none !important;
}

/* Nutze den vollen Platz ohne Sidebar */
.main-content {
    margin-left: 0 !important;
    padding-top: 70px;
}

/* Smooth scroll behavior */
html {
    scroll-behavior: smooth;
}

/* Template card highlight animation */
.template-card {
    transition: all 0.3s ease;
}

.template-card:target {
    border: 2px solid #007bff !important;
    box-shadow: 0 0 15px rgba(0, 123, 255, 0.3);
}

/* Scrollbar für Navigation */
.template-navigation .card-body {
    max-height: 80vh;
    overflow-y: auto;
}

.template-navigation .card-body::-webkit-scrollbar {
    width: 8px;
}

.template-navigation .card-body::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.template-navigation .card-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.template-navigation .card-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Responsive Anpassungen */
@media (max-width: 768px) {
    .template-nav-col {
        margin-bottom: 20px;
    }
    
    .template-nav-item h6 {
        font-size: 0.9rem;
    }
    
    .template-nav-item small {
        font-size: 0.75rem;
    }
}

/* Badge Styling */
.badge.bg-info {
    background-color: #17a2b8 !important;
}

/* Filter Info Styling */
#filterInfo {
    font-style: italic;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Linke Navigationsleiste für Templates - Jetzt breiter ohne Sidebar -->
        <div class="col-md-4 col-lg-3 template-nav-col">
            <div class="card h-100 template-navigation" style="min-height: 80vh;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-layer-group"></i> Positionsvorlagen</h5>
                </div>
                <div class="card-body p-0">
                    <!-- Suchfeld in der Navigation -->
                    <div class="p-3 border-bottom">
                        <input type="text" class="form-control" id="navSearchInput" 
                               placeholder="Vorlage suchen..." onkeyup="filterNavTemplates()">
                    </div>
                    
                    <!-- Template-Liste in der Navigation -->
                    <div class="list-group list-group-flush" id="templateNavList">
                        {% for template in templates %}
                        <a href="#template_{{ template.id }}" 
                           class="list-group-item list-group-item-action template-nav-item" 
                           data-template-id="{{ template.id }}"
                           data-name="{{ template.name|lower }}"
                           onclick="scrollToTemplate({{ template.id }})">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 text-truncate">{{ template.name }}</h6>
                                    {% if template.description %}
                                    <small class="text-muted text-truncate d-block">
                                        {{ template.description[:40] }}{% if template.description|length > 40 %}...{% endif %}
                                    </small>
                                    {% endif %}
                                    
                                    <!-- Kalkulationsfelder Anzeige -->
                                    {% if template.enable_length or template.enable_width or template.enable_height or template.enable_area or template.enable_volume %}
                                    <div class="mt-1">
                                        <small class="badge bg-info me-1">
                                            <i class="fas fa-calculator"></i>
                                            {% set field_count = 0 %}
                                            {% if template.enable_length %}{% set field_count = field_count + 1 %}{% endif %}
                                            {% if template.enable_width %}{% set field_count = field_count + 1 %}{% endif %}
                                            {% if template.enable_height %}{% set field_count = field_count + 1 %}{% endif %}
                                            {% if template.enable_area %}{% set field_count = field_count + 1 %}{% endif %}
                                            {% if template.enable_volume %}{% set field_count = field_count + 1 %}{% endif %}
                                            {{ field_count }} Felder
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ template.subitems|length }} Pos.</small>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hauptinhalt -->
        <div class="col-md-8 col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="fas fa-layer-group"></i> Positionsvorlage auswählen</h1>
                    <p class="text-muted">
                        Angebot: <strong>{{ quote.quote_number }}</strong> - {{ quote.customer.first_name }} {{ quote.customer.last_name }}
                    </p>
                </div>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="closeTemplateSelector()">
                        <i class="fas fa-times"></i> Schließen
                    </button>
                    <small class="text-muted">Sie können mehrere Vorlagen hintereinander hinzufügen</small>
                </div>
            </div>

            <!-- Filter und Aktionen -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Vorlage suchen</label>
                                    <input type="text" class="form-control" id="searchInput" 
                                           placeholder="Vorlagenname..." onkeyup="filterTemplates()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Nach Kalkulationsfeldern filtern</label>
                                    <select class="form-select" id="calcFieldFilter" onchange="filterTemplates()">
                                        <option value="">Alle Vorlagen</option>
                                        <option value="has_calc">Mit Kalkulationsfeldern</option>
                                        <option value="no_calc">Ohne Kalkulationsfelder</option>
                                    </select>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-outline-primary me-2" onclick="filterTemplates()">
                                        <i class="fas fa-filter"></i> Filtern
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                        <i class="fas fa-times"></i> Zurücksetzen
                                    </button>
                                </div>
                            </div>
                            <!-- Filterinformationen -->
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted" id="filterInfo">{{ templates|length }} von {{ templates|length }} Vorlagen angezeigt</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Verfügbare Vorlagen -->
            <div class="row" id="templatesContainer">
                {% for template in templates %}
                <div class="col-12 mb-4 template-card" 
                     id="template_{{ template.id }}"
                     data-name="{{ template.name|lower }}"
                     data-has-calc="{% if template.enable_length or template.enable_width or template.enable_height or template.enable_area or template.enable_volume %}true{% else %}false{% endif %}">
                    <div class="card h-100">
                        <div class="card-header">
                            <strong>{{ template.name }}</strong>
                        </div>
                <div class="card-body">
                    {% if template.description %}
                        <p class="card-text">{{ template.description[:100] }}{% if template.description|length > 100 %}...{% endif %}</p>
                    {% endif %}
                    
                    <!-- Berechnungsfelder für diese Vorlage -->
                    {% if template.enable_length or template.enable_width or template.enable_height or template.enable_area or template.enable_volume %}
                    <div class="card mb-3" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
                        <div class="card-body p-3">
                            <h6 class="mb-3"><i class="fas fa-calculator"></i> Berechnungsparameter</h6>
                            <div class="row g-2">
                                {% if template.enable_length %}
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label form-label-sm">Länge (cm)</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="length_{{ template.id }}" 
                                           data-template-id="{{ template.id }}"
                                           step="0.1" min="0" value="0"
                                           onchange="updateCalculation(this.dataset.templateId)">
                                </div>
                                {% endif %}
                                {% if template.enable_width %}
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label form-label-sm">Breite (cm)</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="width_{{ template.id }}" 
                                           data-template-id="{{ template.id }}"
                                           step="0.1" min="0" value="0"
                                           onchange="updateCalculation(this.dataset.templateId)">
                                </div>
                                {% endif %}
                                {% if template.enable_height %}
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label form-label-sm">Höhe (cm)</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="height_{{ template.id }}" 
                                           data-template-id="{{ template.id }}"
                                           step="0.1" min="0" value="0"
                                           onchange="updateCalculation(this.dataset.templateId)">
                                </div>
                                {% endif %}
                                <div class="col-md-3 col-sm-6">
                                    {% if template.enable_area %}
                                    <small class="text-muted d-block">Fläche: <span id="area_{{ template.id }}">0.00</span> m²</small>
                                    {% endif %}
                                    {% if template.enable_volume %}
                                    <small class="text-muted d-block">Volumen: <span id="volume_{{ template.id }}">0.00</span> m³</small>
                                    {% endif %}
                                    {% set template_base_price = 0 %}
                                    {% if template.subitems %}
                                        {% for subitem in template.subitems %}
                                            {% set template_base_price = template_base_price + (subitem.price_per_unit or 0) %}
                                        {% endfor %}
                                    {% endif %}
                                    <small class="text-success fw-bold">Gesamtpreis: <span id="calculated_price_{{ template.id }}">{{ "%.2f"|format(template_base_price) }}€</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="card mb-3" style="background-color: #fff3cd; border: 1px solid #ffeaa7;">
                        <div class="card-body p-3">
                            <h6 class="mb-2"><i class="fas fa-info-circle"></i> Keine Berechnungsfelder aktiviert</h6>
                            <p class="mb-0 small text-muted">Für diese Vorlage sind keine Kalkulationsfelder aktiviert. Bearbeiten Sie die Vorlage in den Stammdaten, um Berechnungsfelder hinzuzufügen.</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Template bearbeiten -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-edit"></i> Positionen bearbeiten</h6>
                        </div>
                        <div class="card-body p-0">
                            <div id="subitems_{{ template.id }}" class="subitems-container">
                                {% for subitem in template.subitems %}
                                <div class="subitem-row border-bottom p-3" id="subitem_{{ template.id }}_{{ loop.index0 }}" data-subitem-index="{{ loop.index0 }}">
                                    <div class="row align-items-center mb-2">
                                        <div class="col-md-3">
                                            <label class="form-label form-label-sm">Beschreibung</label>
                                            <input type="text" class="form-control form-control-sm subitem-description" 
                                                   value="{{ subitem.description }}" 
                                                   data-template-id="{{ template.id }}" data-subitem-index="{{ loop.index0 }}"
                                                   onchange="updateSubItemCalculation(this.dataset.templateId, this.dataset.subitemIndex)">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label form-label-sm">Typ</label>
                                            <input type="text" class="form-control form-control-sm subitem-type" 
                                                   value="{{ subitem.item_type }}" readonly>
                                        </div>
                                        <div class="col-md-2" id="grundpreis_{{ template.id }}_{{ loop.index0 }}">
                                            <label class="form-label form-label-sm">Grundpreis</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control subitem-base-price" 
                                                       value="{{ subitem.price_per_unit or 0 }}" 
                                                       step="0.01" min="0"
                                                       data-template-id="{{ template.id }}" data-subitem-index="{{ loop.index0 }}"
                                                       onchange="updateSubItemCalculation(this.dataset.templateId, this.dataset.subitemIndex)">
                                                <span class="input-group-text">€</span>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label form-label-sm">Berechneter Preis</label>
                                            <div class="text-success fw-bold subitem-calculated-price" id="subitem_price_{{ template.id }}_{{ loop.index0 }}">
                                                {{ "%.2f"|format(subitem.price_per_unit or 0) }}€
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label form-label-sm">Berechnungsformel</label>
                                            <input type="text" class="form-control form-control-sm subitem-formula" 
                                                   value="{{ subitem.formula or '' }}" 
                                                   placeholder="Keine Formel"
                                                   readonly style="background-color: #f8f9fa;">
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label form-label-sm">&nbsp;</label>
                                            <button type="button" class="btn btn-sm btn-outline-danger w-100" 
                                                    data-template-id="{{ template.id }}" data-subitem-index="{{ loop.index0 }}"
                                                    onclick="removeSubItem(this.dataset.templateId, this.dataset.subitemIndex)"
                                                    title="Unterposition entfernen">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Erweiterte Felder je nach Typ -->
                                    <div class="row subitem-fields" id="fields_{{ template.id }}_{{ loop.index0 }}">
                                        {% if subitem.item_type == 'bestellteil' %}
                                        <div class="col-md-3">
                                            <label class="form-label form-label-sm">Lieferant</label>
                                            <select class="form-select form-select-sm subitem-supplier">
                                                <option value="">Lieferant wählen</option>
                                                {% for supplier in suppliers %}
                                                <option value="{{ supplier.name }}" {% if subitem.supplier == supplier.name %}selected{% endif %}>{{ supplier.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label form-label-sm">Lieferantenteilenummer</label>
                                            <input type="text" class="form-control form-control-sm subitem-supplier-part-number" 
                                                   value="{{ subitem.part_number or '' }}"
                                                   placeholder="z.B. AB-12345">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label form-label-sm">Menge</label>
                                            <input type="text" class="form-control form-control-sm subitem-quantity" 
                                                   value="{{ subitem.part_quantity or '1' }}" 
                                                   data-template-id="{{ template.id }}" data-subitem-index="{{ loop.index0 }}"
                                                   onchange="updateSubItemCalculation(this.dataset.templateId, this.dataset.subitemIndex)">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label form-label-sm">Einheit</label>
                                            <input type="text" class="form-control form-control-sm subitem-unit" 
                                                   value="{{ subitem.unit or 'Stk' }}" readonly>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check mt-4">
                                                <input type="checkbox" class="form-check-input subitem-requires-order" 
                                                       {% if subitem.requires_order or subitem.item_type == 'bestellteil' %}checked{% endif %}>
                                                <label class="form-check-label form-label-sm">Bestellung nötig</label>
                                            </div>
                                        </div>
                                        {% elif subitem.item_type == 'arbeitsvorgang' %}
                                        <div class="col-md-3">
                                            <label class="form-label form-label-sm">Stunden</label>
                                            <input type="number" class="form-control form-control-sm subitem-hours" 
                                                   value="{{ subitem.hours or 0 }}" 
                                                   step="0.1" min="0"
                                                   data-template-id="{{ template.id }}" data-subitem-index="{{ loop.index0 }}"
                                                   onchange="updateSubItemCalculation(this.dataset.templateId, this.dataset.subitemIndex)">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label form-label-sm">Stundensatz</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control subitem-hourly-rate" 
                                                       value="{{ subitem.hourly_rate or 95 }}" 
                                                       step="0.01" min="0"
                                                       data-template-id="{{ template.id }}" data-subitem-index="{{ loop.index0 }}"
                                                       onchange="updateSubItemCalculation(this.dataset.templateId, this.dataset.subitemIndex)">
                                                <span class="input-group-text">€</span>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="col-md-3">
                                            <label class="form-label form-label-sm">Menge</label>
                                            <input type="text" class="form-control form-control-sm subitem-quantity" 
                                                   value="{{ subitem.quantity or '1' }}" 
                                                   data-template-id="{{ template.id }}" data-subitem-index="{{ loop.index0 }}"
                                                   onchange="updateSubItemCalculation(this.dataset.templateId, this.dataset.subitemIndex)">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label form-label-sm">Einheit</label>
                                            <input type="text" class="form-control form-control-sm subitem-unit" 
                                                   value="{{ subitem.unit or 'Stk' }}" readonly>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Template-Info -->
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <small class="text-muted">Positionen</small>
                            <div><strong>{{ template.subitems|length if template.subitems else 0 }}</strong></div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Grundpreis</small>
                            {% set base_price = 0 %}
                            {% if template.subitems %}
                                {% for subitem in template.subitems %}
                                    {% set base_price = base_price + (subitem.price_per_unit or 0) %}
                                {% endfor %}
                            {% endif %}
                            <div><strong class="text-info">{{ "%.2f"|format(base_price) }}€</strong></div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Erstellt</small>
                            <div><small>{{ template.created_at.strftime('%d.%m.%y') if template.created_at else 'N/A' }}</small></div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-outline-info btn-sm w-100" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#preview_{{ template.id }}">
                                <i class="fas fa-eye"></i> Details anzeigen
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-success btn-sm w-100" data-template-id="{{ template.id }}" onclick="selectTemplate(this.dataset.templateId)">
                                <i class="fas fa-check"></i> Vorlage verwenden
                            </button>
                        </div>
                    </div>
                    
                    <!-- Vorschau der Unterpositionen -->
                    <div class="collapse mt-3" id="preview_{{ template.id }}">
                        <div class="card card-body">
                            <h6>Enthaltene Positionen:</h6>
                            {% if template.subitems %}
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Position</th>
                                                <th>Typ</th>
                                                <th>Einheit</th>
                                                <th>Preis</th>
                                                <th>Formel</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for subitem in template.subitems %}
                                            <tr>
                                                <td>{{ subitem.description }}</td>
                                                <td>
                                                    {% if subitem.item_type == 'bestellteil' %}
                                                        <span class="badge bg-warning text-dark">Material</span>
                                                    {% elif subitem.item_type == 'arbeitsvorgang' %}
                                                        <span class="badge bg-info">Arbeitsvorgang</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">Sonstiges</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ subitem.unit or '-' }}</td>
                                                <td>{{ "%.2f"|format(subitem.price_per_unit or 0) }}€</td>
                                                <td>
                                                    {% if subitem.formula %}
                                                        <code class="text-muted small">{{ subitem.formula }}</code>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">Keine Unterpositionen definiert</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% if not templates %}
    <div class="text-center py-5">
        <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Keine Positionsvorlagen verfügbar</h5>
        <p class="text-muted">Erstellen Sie zuerst Vorlagen in den Stammdaten.</p>
        <a href="{{ url_for('template_management') }}" class="btn btn-primary" target="_blank">
            <i class="fas fa-plus"></i> Vorlagen verwalten
        </a>
    </div>
    {% endif %}
</div>

<!-- Lieferanten-Daten für JavaScript -->
<script type="application/json" id="suppliers-data">
{{ suppliers | map(attribute='name') | list | tojson }}
</script>

<script>
// Lieferanten-Daten laden
var suppliers = JSON.parse(document.getElementById('suppliers-data').textContent);

// Lokale Daten für Template-Auswahl
let selectedTemplateData = null;

// Initialisiere Template-Berechnungen beim Laden
document.addEventListener('DOMContentLoaded', function() {
    const templates = document.querySelectorAll('.template-card');
    templates.forEach(card => {
        // Extrahiere Template-ID aus der Karte
        const templateCard = card.querySelector('.card');
        if (!templateCard) return;
        
        // Finde Template-ID aus den Berechnungsfeldern
        const lengthField = card.querySelector('[id^="length_"]');
        const templateId = lengthField ? lengthField.id.split('_')[1] : null;
        
        if (templateId) {
            // Initialisiere Berechnungen
            updateCalculation(templateId);
        }
        
        // Initialisiere alle Subitem-Berechnungen und Sichtbarkeiten
        const subitems = card.querySelectorAll('.subitem-row');
        subitems.forEach(subitem => {
            const subitemIndex = subitem.dataset.subitemIndex;
            if (subitemIndex !== null && templateId) {
                const index = parseInt(subitemIndex);
                // Erst Sichtbarkeit setzen, dann Berechnung
                updateGrundpreisVisibility(templateId, index);
                updateSubItemCalculation(templateId, index);
            }
        });
    });
    
    // Suchfeld fokussieren
    const searchField = document.getElementById('searchInput');
    if (searchField) searchField.focus();
});

// Filter und Suche
function filterTemplates() {
    const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const cards = document.querySelectorAll('.template-card');
    cards.forEach(card => {
        const cardName = (card.getAttribute('data-name') || '').toLowerCase();
        const searchMatch = !search || cardName.includes(search);
        card.style.display = searchMatch ? '' : 'none';
    });
}

function resetFilters() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.value = '';
    filterTemplates();
}

// Hauptberechnung für Template aktualisieren
function updateCalculation(templateId) {
    const length = parseFloat(document.getElementById(`length_${templateId}`)?.value) || 0;
    const width = parseFloat(document.getElementById(`width_${templateId}`)?.value) || 0;
    const height = parseFloat(document.getElementById(`height_${templateId}`)?.value) || 0;
    
    // Berechne Fläche in m²
    const area = (length * width) / 10000;
    const areaElement = document.getElementById(`area_${templateId}`);
    if (areaElement) {
        areaElement.textContent = area.toFixed(2);
    }
    
    // Berechne Volumen in m³
    const volume = (length * width * height) / 1000000;
    const volumeElement = document.getElementById(`volume_${templateId}`);
    if (volumeElement) {
        volumeElement.textContent = volume.toFixed(2);
    }
    
    // Berechne alle Unterpositionen neu (wichtig für Formeln)
    const subitems = document.querySelectorAll(`#subitems_${templateId} .subitem-row`);
    subitems.forEach((subitem, index) => {
        updateSubItemCalculation(templateId, index);
    });
    
    // Berechne Gesamtpreis basierend auf allen Unterpositionen
    updateTemplateTotal(templateId);
}

// Gesamtpreis des Templates aktualisieren
function updateTemplateTotal(templateId) {
    const subitems = document.querySelectorAll(`#subitems_${templateId} .subitem-row`);
    let totalPrice = 0;
    
    subitems.forEach(subitem => {
        const priceElement = subitem.querySelector('.subitem-calculated-price');
        if (priceElement) {
            const priceText = priceElement.textContent.replace('€', '');
            totalPrice += parseFloat(priceText) || 0;
        }
    });
    
    const totalElement = document.getElementById(`calculated_price_${templateId}`);
    if (totalElement) {
        totalElement.textContent = totalPrice.toFixed(2) + '€';
    }
}

// Sichtbarkeit des Grundpreis-Feldes steuern
function updateGrundpreisVisibility(templateId, subitemIndex) {
    const subitemRow = document.getElementById(`subitem_${templateId}_${subitemIndex}`);
    if (!subitemRow) return;
    
    const typeElement = subitemRow.querySelector('.subitem-type');
    const type = typeElement ? typeElement.value : '';
    const formulaElement = subitemRow.querySelector('.subitem-formula');
    const formula = formulaElement ? formulaElement.value : '';
    
    const grundpreisElement = document.getElementById(`grundpreis_${templateId}_${subitemIndex}`);
    if (!grundpreisElement) return;
    
    // Grundpreis ausblenden für Arbeitsvorgang mit "Keine Formel"
    if (type === 'arbeitsvorgang' && (!formula || formula.trim() === '' || formula.trim() === 'Keine Formel')) {
        grundpreisElement.style.display = 'none';
    } else {
        grundpreisElement.style.display = 'block';
    }
}

// Einzelne Unterposition berechnen
function updateSubItemCalculation(templateId, subitemIndex) {
    const subitemRow = document.getElementById(`subitem_${templateId}_${subitemIndex}`);
    if (!subitemRow) return;
    
    // Sichtbarkeit des Grundpreis-Feldes aktualisieren
    updateGrundpreisVisibility(templateId, subitemIndex);
    
    const typeElement = subitemRow.querySelector('.subitem-type');
    const type = typeElement ? typeElement.value : '';
    const basePrice = parseFloat(subitemRow.querySelector('.subitem-base-price')?.value) || 0;
    const formulaElement = subitemRow.querySelector('.subitem-formula');
    const formula = formulaElement ? formulaElement.value : '';
    
    let calculatedPrice = 0;
    let quantity = 1;
    
    // Hole Berechnungsparameter
    const length = parseFloat(document.getElementById(`length_${templateId}`)?.value) || 0;
    const width = parseFloat(document.getElementById(`width_${templateId}`)?.value) || 0;
    const height = parseFloat(document.getElementById(`height_${templateId}`)?.value) || 0;
    const area = (length * width) / 10000; // in m²
    const volume = (length * width * height) / 1000000; // in m³
    
    // Berechnung nach Typ
    if (type === 'bestellteil') {
        // 1. Für Bestellteil: Berechneter Preis = Menge * Grundpreis
        const quantityInput = subitemRow.querySelector('.subitem-quantity');
        quantity = parseFloat(quantityInput?.value) || 1;
        calculatedPrice = quantity * basePrice;
    }
    else if (type === 'sonstiges') {
        if (!formula || formula.trim() === '' || formula.trim() === 'Keine Formel') {
            // 2. Für Sonstiges & Berechnungsformel = "Keine Formel": Berechneter Preis = Menge * Grundpreis
            const quantityInput = subitemRow.querySelector('.subitem-quantity');
            quantity = parseFloat(quantityInput?.value) || 1;
            calculatedPrice = quantity * basePrice;
        } else {
            // 3. Für Sonstiges mit Berechnungsformel:
            // a. Menge = Ergebnis der Formel / 10000
            // b. Berechneter Preis = Grundpreis * Menge
            try {
                let evalFormula = formula
                    .replace(/laenge/g, length.toString())
                    .replace(/breite/g, width.toString())
                    .replace(/hoehe/g, height.toString())
                    .replace(/flaeche/g, area.toString())
                    .replace(/volumen/g, volume.toString())
                    // Englische Variablennamen für Rückwärtskompatibilität
                    .replace(/length/g, length.toString())
                    .replace(/width/g, width.toString())
                    .replace(/height/g, height.toString())
                    .replace(/area/g, area.toString())
                    .replace(/volume/g, volume.toString());
                
                // Nur grundlegende mathematische Operationen erlauben
                if (/^[0-9+\-*/(). ]+$/.test(evalFormula)) {
                    const formulaResult = eval(evalFormula);
                    quantity = formulaResult / 10000;
                    calculatedPrice = basePrice * quantity;
                    
                    // Aktualisiere das Mengenfeld
                    const quantityInput = subitemRow.querySelector('.subitem-quantity');
                    if (quantityInput) {
                        quantityInput.value = quantity.toFixed(1);
                    }
                } else {
                    // Fallback bei ungültiger Formel
                    quantity = 1;
                    calculatedPrice = basePrice;
                }
            } catch (e) {
                console.warn('Fehler in Formel:', formula, e);
                quantity = 1;
                calculatedPrice = basePrice;
            }
        }
    }
    else if (type === 'arbeitsvorgang') {
        if (!formula || formula.trim() === '' || formula.trim() === 'Keine Formel') {
            // 4. Arbeitsvorgang & Berechnungsformel = "Keine Formel": Berechneter Preis = Stunden * Stundensatz
            const hours = parseFloat(subitemRow.querySelector('.subitem-hours')?.value) || 0;
            const hourlyRate = parseFloat(subitemRow.querySelector('.subitem-hourly-rate')?.value) || 95;
            calculatedPrice = hours * hourlyRate;
        } else {
            // 5. Arbeitsvorgang & Berechnungsformel mit Formel:
            // a. Menge = Ergebnis der Formel / 10000
            // b. Berechneter Preis = Grundpreis * Menge
            try {
                let evalFormula = formula
                    .replace(/laenge/g, length.toString())
                    .replace(/breite/g, width.toString())
                    .replace(/hoehe/g, height.toString())
                    .replace(/flaeche/g, area.toString())
                    .replace(/volumen/g, volume.toString())
                    // Englische Variablennamen für Rückwärtskompatibilität
                    .replace(/length/g, length.toString())
                    .replace(/width/g, width.toString())
                    .replace(/height/g, height.toString())
                    .replace(/area/g, area.toString())
                    .replace(/volume/g, volume.toString());
                
                // Nur grundlegende mathematische Operationen erlauben
                if (/^[0-9+\-*/(). ]+$/.test(evalFormula)) {
                    const formulaResult = eval(evalFormula);
                    quantity = formulaResult / 10000;
                    calculatedPrice = basePrice * quantity;
                    
                    // Aktualisiere das Mengenfeld
                    const quantityInput = subitemRow.querySelector('.subitem-quantity');
                    if (quantityInput) {
                        quantityInput.value = quantity.toFixed(1);
                    }
                } else {
                    // Fallback bei ungültiger Formel
                    quantity = 1;
                    calculatedPrice = basePrice;
                }
            } catch (e) {
                console.warn('Fehler in Formel:', formula, e);
                quantity = 1;
                calculatedPrice = basePrice;
            }
        }
    }
    
    // Preis anzeigen
    const priceElement = subitemRow.querySelector('.subitem-calculated-price');
    if (priceElement) {
        priceElement.textContent = calculatedPrice.toFixed(2) + '€';
    }
    
    // Template-Gesamtpreis aktualisieren
    updateTemplateTotal(templateId);
}

// Unterposition entfernen
function removeSubItem(templateId, subitemIndex) {
    if (confirm('Möchten Sie diese Unterposition wirklich entfernen?')) {
        const subitemRow = document.getElementById(`subitem_${templateId}_${subitemIndex}`);
        if (subitemRow) {
            subitemRow.remove();
            
            // Aktualisiere die Indizes der verbleibenden Unterpositionen
            const remainingSubitems = document.querySelectorAll(`#subitems_${templateId} .subitem-row`);
            remainingSubitems.forEach((subitem, newIndex) => {
                // Aktualisiere ID und data-subitem-index
                subitem.id = `subitem_${templateId}_${newIndex}`;
                subitem.setAttribute('data-subitem-index', newIndex);
                
                // Aktualisiere onclick-Events
                const removeBtn = subitem.querySelector('button[onclick*="removeSubItem"]');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeSubItem(${templateId}, ${newIndex})`);
                }
                
                // Aktualisiere onchange-Events
                const changeElements = subitem.querySelectorAll('[onchange*="updateSubItemCalculation"]');
                changeElements.forEach(element => {
                    element.setAttribute('onchange', `updateSubItemCalculation(${templateId}, ${newIndex})`);
                });
                
                // Aktualisiere Preis-Element ID
                const priceElement = subitem.querySelector('.subitem-calculated-price');
                if (priceElement) {
                    priceElement.id = `subitem_price_${templateId}_${newIndex}`;
                }
                
                // Aktualisiere Grundpreis-Element ID
                const grundpreisElement = document.getElementById(`grundpreis_${templateId}_${parseInt(subitem.dataset.subitemIndex)}`);
                if (grundpreisElement) {
                    grundpreisElement.id = `grundpreis_${templateId}_${newIndex}`;
                }
            });
            
            // Aktualisiere Template-Gesamtpreis
            updateTemplateTotal(templateId);
        }
    }
}

// Template auswählen und alle Daten sammeln
function selectTemplate(templateId) {
    // Sammle alle Daten der bearbeiteten Vorlage
    const templateData = {
        template_id: templateId,
        calculation_parameters: {
            length: parseFloat(document.getElementById(`length_${templateId}`)?.value) || 0,
            width: parseFloat(document.getElementById(`width_${templateId}`)?.value) || 0,
            height: parseFloat(document.getElementById(`height_${templateId}`)?.value) || 0,
            area: (parseFloat(document.getElementById(`length_${templateId}`)?.value) || 0) * 
                  (parseFloat(document.getElementById(`width_${templateId}`)?.value) || 0) / 10000,
            volume: (parseFloat(document.getElementById(`length_${templateId}`)?.value) || 0) * 
                    (parseFloat(document.getElementById(`width_${templateId}`)?.value) || 0) * 
                    (parseFloat(document.getElementById(`height_${templateId}`)?.value) || 0) / 1000000
        },
        subitems: []
    };

    // Sammle alle Unterposition-Daten
    const subitems = document.querySelectorAll(`#subitems_${templateId} .subitem-row`);
    subitems.forEach(subitem => {
        const typeElement = subitem.querySelector('.subitem-type');
        const type = typeElement ? typeElement.value : '';
        const description = subitem.querySelector('.subitem-description')?.value || '';
        const basePrice = parseFloat(subitem.querySelector('.subitem-base-price')?.value) || 0;
        const formulaElement = subitem.querySelector('.subitem-formula');
        const formula = formulaElement ? formulaElement.value : '';
        const calculatedPriceText = subitem.querySelector('.subitem-calculated-price')?.textContent || '0€';
        const calculatedPrice = parseFloat(calculatedPriceText.replace('€', '')) || 0;

        const subitemData = {
            description: description,
            item_type: type.toLowerCase(),  // Konvertiere zu Kleinschreibung für quote_edit Kompatibilität
            base_price: basePrice,
            calculated_price: calculatedPrice,
            formula: formula
        };

        // Typ-spezifische Daten
        if (type === 'bestellteil') {
            subitemData.supplier = subitem.querySelector('.subitem-supplier')?.value || '';
            subitemData.supplier_part_number = subitem.querySelector('.subitem-supplier-part-number')?.value || '';
            subitemData.part_quantity = subitem.querySelector('.subitem-quantity')?.value || '1';
            subitemData.requires_order = subitem.querySelector('.subitem-requires-order')?.checked || true;
        } else if (type === 'arbeitsvorgang') {
            subitemData.hours = parseFloat(subitem.querySelector('.subitem-hours')?.value) || 0;
            subitemData.hourly_rate = parseFloat(subitem.querySelector('.subitem-hourly-rate')?.value) || 95;
        } else {
            subitemData.quantity = subitem.querySelector('.subitem-quantity')?.value || '1';
        }

        templateData.subitems.push(subitemData);
    });

    // Berechne Gesamtpreis
    templateData.calculation_parameters.calculatedPrice = templateData.subitems.reduce((sum, item) => sum + item.calculated_price, 0);

    // Sende Daten an Backend
    fetch(`/quotes/{{ quote.id }}/add_template`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(templateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Kommuniziere mit dem Elternfenster
            if (window.opener) {
                // Sende sowohl die neue PostMessage als auch die alte für Kompatibilität
                window.opener.postMessage({
                    type: 'template_added',
                    data: templateData,
                    message: data.message
                }, '*');
                
                // Neues verbessertes PostMessage für direktes Update
                window.opener.postMessage({
                    type: 'TEMPLATE_ADDED_AND_REFRESH',
                    templateData: templateData,
                    message: data.message,
                    success: true
                }, '*');
                
                // Fenster NICHT schließen - zeige nur Erfolgs-Alert
                alert(data.message + ' - Sie können weitere Vorlagen hinzufügen.');
                
            } else {
                alert(data.message);
                window.location.reload();
            }
        } else {
            alert('Fehler: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Hinzufügen der Vorlage!');
    });
}

// Template-Auswahl abbrechen
function closeTemplateSelector() {
    if (window.opener) {
        window.opener.postMessage({
            type: 'TEMPLATE_CANCELLED'
        }, window.location.origin);
    }
    
    // Visuelles Feedback vor dem Schließen
    document.body.style.opacity = '0.5';
    setTimeout(() => {
        window.close();
    }, 200);
}

// Tastatur-Shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeTemplateSelector();
    }
});

// Navigation Funktionen
function scrollToTemplate(templateId) {
    const templateElement = document.getElementById(`template_${templateId}`);
    if (templateElement) {
        templateElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start',
            inline: 'nearest'
        });
        
        // Hervorheben des Templates
        templateElement.style.border = '2px solid #007bff';
        setTimeout(() => {
            templateElement.style.border = '';
        }, 2000);
        
        // Aktiven Navigationseintrag markieren
        document.querySelectorAll('.template-nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-template-id="${templateId}"]`).classList.add('active');
    }
}

function filterNavTemplates() {
    const searchValue = document.getElementById('navSearchInput').value.toLowerCase();
    const navItems = document.querySelectorAll('.template-nav-item');
    
    navItems.forEach(item => {
        const name = item.dataset.name;
        if (name.includes(searchValue)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Erweiterte Filter-Funktionen
function filterTemplates() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const calcFieldFilter = document.getElementById('calcFieldFilter').value;
    const templateCards = document.querySelectorAll('.template-card');
    
    let visibleCount = 0;
    
    templateCards.forEach(card => {
        const name = card.dataset.name;
        const hasCalc = card.dataset.hasCalc === 'true';
        
        let nameMatch = name.includes(searchValue);
        let calcMatch = true;
        
        if (calcFieldFilter === 'has_calc') {
            calcMatch = hasCalc;
        } else if (calcFieldFilter === 'no_calc') {
            calcMatch = !hasCalc;
        }
        
        if (nameMatch && calcMatch) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Sync Navigation
    filterNavTemplates();
    
    // Zeige Anzahl der sichtbaren Templates
    updateFilterInfo(visibleCount);
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('navSearchInput').value = '';
    document.getElementById('calcFieldFilter').value = '';
    
    document.querySelectorAll('.template-card').forEach(card => {
        card.style.display = 'block';
    });
    
    document.querySelectorAll('.template-nav-item').forEach(item => {
        item.style.display = 'block';
    });
    
    updateFilterInfo({{ templates|length }});
}

function updateFilterInfo(count) {
    // Optional: Zeige Filterinformationen an
    const info = document.getElementById('filterInfo');
    if (info) {
        info.textContent = `${count} von {{ templates|length }} Vorlagen angezeigt`;
    }
}

// Initialisierung
document.addEventListener('DOMContentLoaded', function() {
    updateFilterInfo({{ templates|length }});
    
    // Initialisiere Zähler für hinzugefügte Vorlagen
    window.addedTemplatesCount = 0;
    
    // Sync beide Suchfelder
    document.getElementById('searchInput').addEventListener('input', function() {
        document.getElementById('navSearchInput').value = this.value;
        filterTemplates();
    });
    
    document.getElementById('navSearchInput').addEventListener('input', function() {
        document.getElementById('searchInput').value = this.value;
        filterTemplates();
    });
});
</script>

        </div> <!-- Ende Hauptinhalt col-md-9 -->
    </div> <!-- Ende row -->
</div> <!-- Ende container-fluid -->

{% endblock %}
